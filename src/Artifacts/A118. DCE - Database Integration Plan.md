# Artifact A118: DCE - Database Integration Plan
# Date Created: C118
# Author: AI Model & Curator
# Updated on: C123 (Add troubleshooting for ABI mismatch)

- **Key/Value for A0:**
- **Description:** A plan to transition from the brittle `dce_history.json` file to a robust SQLite database for managing cycle history, solving data loss issues.
- **Tags:** plan, architecture, database, sqlite, persistence, data integrity

## 1. Problem Statement

The current persistence mechanism relies on a single, monolithic JSON file (`.vscode/dce_history.json`). As the project history grows, this file becomes large (potentially 100MB+). The "autosave" feature writes this entire file to disk on every significant change (debounced). This approach has critical flaws:

1.  **Race Conditions:** Rapid navigation or edits can trigger multiple writes, leading to data loss if a write is interrupted or if the in-memory state is stale when a write occurs.
2.  **Performance:** Serializing and writing a huge JSON string is CPU and I/O intensive, causing UI freezes (flashing) and lag.
3.  **Fragility:** A single write error can corrupt the entire history.

## 2. The Solution: SQLite Database

We will replace the live `dce_history.json` with a local SQLite database (`.vscode/dce.db`). SQLite is transactional, atomic, and efficient for partial updates. This ensures that saving a single response or updating a cycle title does not require rewriting the entire history.

The `dce_history.json` format will be retained solely for **Import/Export** functionality, allowing users to share or backup their projects.

## 3. Technical Architecture

### 3.1. Database Technology
-   **Library:** `better-sqlite3`. This library provides a synchronous API that is highly performant and fits well with the VS Code extension architecture (running in the Node.js Extension Host).
-   **File Location:** `.vscode/dce.db` (inside the user's workspace).
-   **Build Configuration (C119):** Because `better-sqlite3` is a native Node.js module, it **must** be excluded from the Webpack bundle. We will add it to the `externals` section of `webpack.config.js`.
-   **Native Module Compatibility (C122):** `better-sqlite3` must be compiled against the specific Electron version used by VS Code.
    -   **Dependency:** Add `@electron/rebuild` and `electron` (matching the target ABI, e.g., `^33.0.0`) to `devDependencies`.
    -   **Script:** Add `"rebuild": "electron-rebuild"` to `package.json`.
    -   **Action:** Run `npm install` followed by `npm run rebuild` whenever native dependencies are added or updated.
    -   **Troubleshooting (C123):** If `NODE_MODULE_VERSION` errors persist, check the "Data Curation Environment" output channel for the `[Env]` log. This log reveals the *exact* Electron version the extension is running in. Run `npm run rebuild -- -v <VERSION> -f` to force a build for that specific version.

### 3.2. Schema Design

**Table: `key_value_store`**
Stores global project settings and state.
| Column | Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `key` | TEXT | PRIMARY KEY | E.g., 'project_scope', 'last_viewed_cycle_id' |
| `value` | TEXT | | JSON stringified value |

**Table: `cycles`**
Stores the metadata for each development cycle.
| Column | Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | INTEGER | PRIMARY KEY | The Cycle ID (0, 1, 2...) |
| `title` | TEXT | | |
| `timestamp` | TEXT | | ISO string |
| `cycle_context` | TEXT | | |
| `ephemeral_context` | TEXT | | |
| `tab_count` | INTEGER | | |
| `active_tab` | INTEGER | | |
| `is_parsed_mode` | INTEGER | | Boolean (0/1) |
| `is_sorted_by_tokens` | INTEGER | | Boolean (0/1) |
| `selected_response_id` | TEXT | | |
| `left_pane_width` | INTEGER | | |
| `status` | TEXT | | 'generating' | 'complete' |
| `connection_mode` | TEXT | | 'manual' | 'demo' | 'url' |
| `active_workflow_step` | TEXT | | |
| `is_ephemeral_context_collapsed` | INTEGER | | Boolean (0/1) |

**Table: `responses`**
Stores the AI responses associated with each cycle.
| Column | Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `cycle_id` | INTEGER | | Foreign Key -> cycles.id |
| `tab_id` | TEXT | | '1', '2', etc. |
| `content` | TEXT | | Raw response content |
| `status` | TEXT | | 'pending' | 'generating' | 'complete' | ... |
| `start_time` | INTEGER | | Timestamp |
| `end_time` | INTEGER | | Timestamp |
| `thinking_tokens` | INTEGER | | |
| `response_tokens` | INTEGER | | |
| PRIMARY KEY | (`cycle_id`, `tab_id`) | | Composite Key |

### 3.3. Migration Strategy

1.  **Detection:** On startup, the `DatabaseService` checks for `.vscode/dce.db`.
2.  **Import:** If the DB is missing but `dce_history.json` exists, it reads the JSON and populates the DB tables.
3.  **Archive:** After successful import, it renames `dce_history.json` to `dce_history.json.bak`.
4.  **Initialization:** If neither exists, it initializes an empty DB with the schema.

## 4. Implementation Plan

1.  **Install Dependencies:** `npm install better-sqlite3`, `npm install --save-dev @electron/rebuild electron`.
2.  **Configure Webpack:** Update `webpack.config.js` to add `better-sqlite3` to `externals`.
3.  **Create `DatabaseService`:** Implement the connection, schema creation, migration logic, and CRUD operations.
4.  **Refactor `HistoryService`:**
    *   Remove file system calls for `.json`.
    *   Inject `DatabaseService`.
    *   Replace `_readHistoryFile` with a method that queries the DB and reconstructs the `PcppHistoryFile` object (to maintain compatibility with `PromptService`).
    *   Replace `saveCycleData` with atomic DB updates (`UPSERT`).
    *   Implement `handleExportHistory` to dump the DB back to JSON format.
    *   Implement `handleImportHistory` to wipe the DB and load from JSON.
5.  **Update `Services`:** Register the new service.