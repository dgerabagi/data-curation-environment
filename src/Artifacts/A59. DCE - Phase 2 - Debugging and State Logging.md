# Artifact A59: DCE - Phase 2 - Debugging and State Logging
# Date Created: C134
# Author: AI Model & Curator

- **Key/Value for A0:**
- **Description:** Documents the plan for a "Log State" button that outputs critical state information (cycle history, current inputs) to the debug channel to accelerate troubleshooting.
- **Tags:** feature plan, phase 2, ui, ux, debugging, logging, state management

## 1. Overview & Goal

Debugging complex state interactions in the Parallel Co-Pilot Panel can be challenging, as it often requires the curator to manually describe the state of multiple text fields and selections. To accelerate this process, a dedicated debugging feature is required.

The goal of this feature is to add a **"Log State"** button to the PCPP's main header. When clicked, this button will generate a comprehensive, formatted log of the panel's current state and send it to the "Data Curation Environment" output channel. This allows the curator to easily copy and paste the exact state of the application into their feedback, eliminating ambiguity and speeding up bug resolution.

## 2. User Story

| ID | User Story | Acceptance Criteria |
|---|---|---|
| P2-LOG-01 | **Log Current State for Debugging** | As a curator encountering a bug, I want to click a "Log State" button that outputs the current state of the entire PCPP to the debug logs, so I can easily copy and paste this information for you to reproduce the issue. | - A "Log State" button is present in the main header of the PCPP. <br> - Clicking the button generates a formatted message in the "Data Curation Environment" output channel. <br> - The log contains two key pieces of information: <br> &nbsp;&nbsp;&nbsp; 1. A formatted JSON dump of the current state of all cycle data (titles, contexts, raw responses). <br> &nbsp;&nbsp;&nbsp; 2. The exact `<M6. Cycles>` block that *would be* generated for `prompt.md` based on the current state. |

## 3. Technical Implementation Plan

1.  **UI (`view.tsx`):**
    *   A new "Log State" button with an appropriate icon (e.g., `VscBug`) will be added to the main `.pc-header` toolbar.
    *   Its `onClick` handler will gather the complete current state of the panel into a single `PcppCycle` object. This includes `currentCycle`, `cycleTitle`, `cycleContext`, `ephemeralContext`, and the `rawContent` from all `tabs`.
    *   This state object will be sent to the backend via a new IPC message.

2.  **IPC Channels (`channels.enum.ts`, `channels.type.ts`):**
    *   Create a new `ClientToServerChannel.RequestLogState`.
    *   The payload will be `{ currentState: PcppCycle }`.

3.  **Backend Logic (`prompt.service.ts`):**
    *   The `PromptService` is the best location for this logic as it already has access to the history service and the logic for generating prompt sections.
    *   A new public method, `public async generateStateLog(currentState: PcppCycle)`, will be created.
    *   **Step 1: Generate Formatted State Dump:**
        *   It will call `Services.historyService.getFullHistory()` to get all historical cycle data.
        *   It will create a new object containing both the `currentState` from the frontend and the `fullHistory`.
        *   It will `JSON.stringify` this object with an indent of 2 for readability.
    *   **Step 2: Generate `<M6. Cycles>` Content:**
        *   It will re-use the existing logic from `generatePromptFile` to construct the complete `<M6. Cycles>` string based on the `currentState` and `fullHistory`.
    *   **Step 3: Log to Output Channel:**
        *   It will combine these two strings into a single, clearly labeled log message.
        *   It will call `Services.loggerService.log()` to write the final string to the "Data Curation Environment" output channel.

4.  **Message Handling (`on-message.ts`):**
    *   A new handler will be added for `RequestLogState` which simply calls the new `generateStateLog` method on the `PromptService`.