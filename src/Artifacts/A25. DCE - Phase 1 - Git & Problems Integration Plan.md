# Artifact A25: DCE - Phase 1 - Git & Problems Integration Plan
# Date Created: C30
# Author: AI Model
# Updated on: C33 (Refine technical plan based on debugging)

- **Key/Value for A0:**
- **Description:** Outlines the user stories and technical approach for integrating Git status indicators and VS Code Problem Diagnostics into the custom file tree.
- **Tags:** feature plan, git, problems, diagnostics, ux, phase 1

## 1. Overview & Goal

To achieve full feature parity with the native VS Code Explorer and provide critical context to the user, the Data Curation Environment (DCE) file tree must display information about a file's Git status and any associated problems (errors/warnings). The goal of this feature is to overlay this diagnostic and source control information directly onto the file tree, allowing users to make more informed decisions during context curation.

**Status (C33):** Actively debugging and refining the implementation. The core issue appears to be in the backend's data gathering from the Git API.

## 2. User Stories

| ID | User Story | Acceptance Criteria |
|---|---|---|
| GP-01 | **Git Status Coloring** | As a user, I want to see files and folders colored according to their Git status (e.g., green for new, yellow for modified, gray for ignored), so I can quickly identify changes in my workspace. | - The file/folder name text color in the tree view changes based on its Git status. <br> - Colors should align with the user's current VS Code theme for Git decorations. <br> - A new, untracked file is green. <br> - A modified file is yellow/orange. <br> - A deleted file (in some views) is red. <br> - An ignored file is gray. |
| GP-02 | **Git Status Badges** | As a user, I want to see a letter badge next to a file's name indicating its specific Git status (e.g., 'U' for untracked, 'M' for modified), so I have an unambiguous indicator of its state. | - A small, colored badge with a letter appears to the right of the file name. <br> - 'U' for Untracked. <br> - 'M' for Modified. <br> - 'D' for Deleted. <br> - 'A' for Added. <br> - 'C' for Conflicted. <br> - The badge has a tooltip explaining the status (e.g., "Modified"). |
| GP-03 | **Problem Indicator Badges** | As a user, I want to see a badge with a count of errors and warnings on files and their parent folders, so I can immediately identify parts of the codebase that have issues. | - A file with problems displays a badge with the number of errors (e.g., in red). <br> - A folder recursively aggregates the problem counts of its children and displays a summary badge. <br> - Tooltips on the badge provide a breakdown (e.g., "2 Errors, 3 Warnings"). <br> - The file name may also be colored (e.g., red for errors, yellow for warnings) to match the Problems panel. |

## 3. Technical Implementation Plan

### Phase 1: Data Gathering (Backend)

1.  **Extend `FileNode` Type:** The `FileNode` interface in `src/common/types/file-node.ts` will be extended to include optional properties:
    ```typescript
    export interface FileNode {
        // ... existing properties
        gitStatus?: string; // e.g., 'M', 'U', 'A', 'D', 'C' for Conflicted
        problemCounts?: { error: number; warning: number; };
    }
    ```

2.  **Git Status Integration (`fs.service.ts`):**
    *   **API Acquisition:** The Git extension API will be acquired in `extension.ts` and passed into the `FSService` during initialization. This ensures it's available and handles cases where the Git extension might not be ready immediately.
    *   **Centralized Status Map:** A `private getGitStatusMap()` method will be created. This method builds a `Map<string, string>` of file paths to their status character.
    *   **Critical: Path Normalization:** All file paths retrieved from the Git API (`change.uri.fsPath`) **must** be normalized to use forward slashes (`/`) immediately before being used as keys in the map. This is the root cause of many cross-platform bugs.
    *   **Comprehensive Status Check:** The map will be populated by iterating through `repository.state.workingTreeChanges`, `repository.state.indexChanges`, and `repository.state.untrackedChanges`.
    *   **Logging:** Add detailed logging to confirm the Git API was found, the number of repositories, and the number of changes detected.

3.  **Problems Integration (`fs.service.ts`):**
    *   Use the `vscode.languages.getDiagnostics()` API. This returns all diagnostics for the entire workspace.
    *   Create a `Map<string, { error: number; warning: number; }>` to store aggregated counts per file URI.
    *   Iterate through the diagnostics and populate the map based on `diagnostic.severity`.
    *   When building the `FileNode` for a file, retrieve its counts from the map and add them to the `problemCounts` property.
    *   The recursive aggregation logic for folders (`_aggregateStats`) will be updated to also sum these `problemCounts`.

### Phase 2: Rendering (Frontend)

1.  **CSS Styling (`view.scss`):**
    *   Create new CSS classes for each Git status (e.g., `.git-status-M`, `.git-status-U`).
    *   Use VS Code theme variables for the colors to ensure consistency (e.g., `var(--vscode-gitDecoration-modifiedResourceForeground)`).
    *   Create classes for problem severity colors (e.g., `.problem-error`, `.problem-warning`) and badges.

2.  **Component Logic (`FileTree.tsx`):**
    *   In `renderFileNodeContent`, add logic to conditionally apply the CSS classes to the file name and the status badge based on the `gitStatus` and `problemCounts` properties of the `FileNode`.
    *   Add a new `<span>` element to render the Git status badge. Add a `title` attribute to this span to provide a helpful tooltip.
    *   Add another `<span>` to render the problem count badge, with a `title` attribute for the tooltip breakdown.