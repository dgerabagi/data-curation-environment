# Artifact A25: DCE - Phase 1 - Git & Problems Integration Plan
# Date Created: C30
# Author: AI Model
# Updated on: C184 (Reflect new decoration-based update architecture)

- **Key/Value for A0:**
- **Description:** Outlines the user stories and technical approach for integrating Git status indicators and VS Code Problem Diagnostics into the custom file tree.
- **Tags:** feature plan, git, problems, diagnostics, ux, phase 1

## 1. Overview & Goal

To achieve full feature parity with the native VS Code Explorer and provide critical context to the user, the Data Curation Environment (DCE) file tree must display information about a file's Git status and any associated problems (errors/warnings). The goal of this feature is to overlay this diagnostic and source control information directly onto the file tree, allowing users to make more informed decisions during context curation.

## 2. User Stories

| ID | User Story | Acceptance Criteria |
|---|---|---|
| GP-01 | **Git Status Coloring** | As a user, I want to see files and folders colored according to their Git status (e.g., green for new, yellow for modified, gray for ignored), so I can quickly identify changes in my workspace. | - The file/folder name text color in the tree view changes based on its Git status. <br> - Colors should align with the user's current VS Code theme for Git decorations. <br> - A new, untracked file is green. <br> - A modified file is yellow/orange. <br> - A deleted file (in some views) is red. <br> - An ignored file is gray. |
| GP-02 | **Git Status Badges** | As a user, I want to see a letter badge next to a file's name indicating its specific Git status (e.g., 'U' for untracked, 'M' for modified), so I have an unambiguous indicator of its state. | - A small, colored badge with a letter appears to the right of the file name. <br> - 'U' for Untracked. <br> - 'M' for Modified. <br> - 'D' for Deleted. <br> - 'A' for Added. <br> - 'C' for Conflicted. <br> - The badge has a tooltip explaining the status (e.g., "Modified"). |
| GP-03 | **Problem Indicator Badges** | As a user, I want to see a badge with a count of errors and warnings on files and their parent folders, so I can immediately identify parts of the codebase that have issues. | - A file with problems displays a badge with the number of errors (e.g., in red). <br> - A folder recursively aggregates the problem counts of its children and displays a summary badge. <br> - Tooltips on the badge provide a breakdown (e.g., "2 Errors, 3 Warnings"). <br> - The file name may also be colored (e.g., red for errors, yellow for warnings) to match the Problems panel. |

## 3. Technical Implementation Plan (C184 Revision)

### Phase 1: Data Gathering (Backend)
The backend is responsible for collecting Git and Problem data and sending it to the client.

-   **Git Status (`file-tree.service.ts`):** A `getGitStatusMap()` method builds a `Map<string, string>` of file paths to their status character by querying the Git API.
-   **Problems (`file-tree.service.ts`):** A `getProblemCountsMap()` method builds a map of file paths to their error/warning counts by querying `vscode.languages.getDiagnostics()`.

### Phase 2: Decoupled Refresh Architecture
To solve the FTV flashing bug, structural refreshes are now decoupled from decoration refreshes.

1.  **Structural Refresh (File Watcher):** The `FileSystemWatcher` is the sole trigger for a full tree rebuild (`ForceRefresh`). This is for file creations, deletions, and renames.
2.  **Decoration Refresh (Git API):** The overly sensitive `repo.state.onDidChange` listener no longer triggers a full refresh. Instead, it triggers a new, lightweight update.
    *   **New IPC Channel:** `ServerToClientChannel.UpdateDecorations` is created to carry the Git status map and the problem map to the client.
    *   **New Backend Method:** A `triggerDecorationsUpdate` method in `file-tree.service.ts` is called by the Git listener. It gathers the latest decoration data and sends it over the new channel.

### Phase 3: Rendering (Frontend)
The frontend receives the file tree structure and decoration data separately and combines them at render time.

-   **State Management (`context-chooser.view/view.tsx`):**
    *   The component maintains the `files` (tree structure), `problemMap`, and a new `gitStatusMap` in its state.
    *   A message handler for `UpdateDecorations` updates the `problemMap` and `gitStatusMap` state variables.
-   **Rendering (`FileTree.tsx`):**
    *   The component receives the `gitStatusMap` and `problemMap` as props.
    *   The `gitStatus` and `problemCounts` properties are **removed** from the `FileNode` type, as this data is no longer static.
    *   When rendering a file node, the component looks up the node's `absolutePath` in the `gitStatusMap` and `problemMap` props to get the most current decoration data.
    *   This allows the Git and problem indicators to update frequently without the expensive process of rebuilding the entire tree structure.