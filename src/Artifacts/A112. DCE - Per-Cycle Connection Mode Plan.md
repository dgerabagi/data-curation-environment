# Artifact A112: DCE - Per-Cycle Connection Mode Plan
# Date Created: C116
# Author: AI Model & Curator

- **Key/Value for A0:**
- **Description:** A plan for a dropdown in the PCPP to allow users to select a generation mode for the current cycle, overriding the global default from the settings panel.
- **Tags:** feature plan, ui, ux, llm, configuration

## 1. Overview & Goal

Currently, the LLM connection mode (e.g., "Manual", "Demo") is a global setting. This is too rigid. A user may want to generate one cycle using the automated "Demo" mode and the next using the "Manual" copy/paste workflow, without having to navigate to the settings panel each time.

The goal of this feature is to provide more flexible, in-context control over the generation mode. We will add a dropdown menu to the main Parallel Co-Pilot Panel (PCPP) that allows the user to select the connection mode for the *current* cycle. The global setting will now only determine the default mode for newly created cycles.

## 2. User Story

| ID | User Story | Acceptance Criteria |
|---|---|---|
| P3-CM-06 | **Per-Cycle Mode Selection** | As a user, I want a dropdown menu in the main PCPP view to select the connection mode (e.g., "Manual", "Demo") for the current cycle, so I can easily switch between different generation workflows without going to the settings panel. | - A dropdown menu is added to the PCPP header toolbar. <br> - It displays the available connection modes. <br> - The selected value in the dropdown determines which "Generate" button is shown ("Generate prompt.md" vs. "Generate responses"). <br> - When a new cycle is created, the dropdown defaults to the mode selected in the main settings panel. <br> - The mode for the current cycle is persisted as part of the cycle's data. |

## 3. Technical Implementation Plan

1.  **Data Model (`pcpp.types.ts`):**
    *   Add a new optional property to the `PcppCycle` interface: `connectionMode?: ConnectionMode;`.

2.  **Backend (`history.service.ts`):**
    *   In `createNewCyclePlaceholder` and the default cycle object in `getInitialCycle`, the new `connectionMode` property will be initialized from the global settings (retrieved from `settings.service.ts`). This ensures new cycles respect the user's default preference.

3.  **Frontend (`view.tsx` and hooks):**
    *   **State Management (`useGeneration.ts`):** The `connectionMode` state will be moved from a simple `useState` to be part of the persisted cycle data managed in `useCycleManagement.ts`. The `useGeneration` hook will receive it as a prop.
    *   **UI (`WorkflowToolbar.tsx` or `pc-header`):**
        *   A new `<select>` dropdown will be added to the UI.
        *   Its `value` will be bound to the `currentCycle.connectionMode`.
        *   Its `onChange` handler will update the `connectionMode` for the current cycle in the state and mark the cycle as `'unsaved'`.
    *   **Conditional Logic (`view.tsx`):** The logic that determines which "Generate" button to show will be updated to read from `currentCycle.connectionMode` instead of the global setting state.

4.  **Backend (`prompt.service.ts`):**
    *   The `getPromptParts` method, which selects the correct interaction schema (`A52.2` vs. `A52.3`), will be updated. It already receives the `cycleData` object. It will now check `cycleData.connectionMode` to make its decision, ensuring the correct schema is used for the per-cycle selection.