# Artifact A96: DCE - Harmony-Aligned Response Schema Plan
# Date Created: C45
# Author: AI Model & Curator

- **Key/Value for A0:**
- **Description:** An analysis of the `openai_harmony` library and a proposed plan for migrating the DCE's vLLM interaction schema from XML tags to a more robust, token-based structured format.
- **Tags:** plan, architecture, interaction schema, parsing, llm, vllm, harmony

## 1. Overview & Goal

The current interaction schema (`A52.2`) relies on parsing XML-like tags (`<file>`, `<summary>`) and markdown headers from the LLM's free-text response. While functional, this approach is brittle. It is susceptible to minor formatting errors from the model and requires complex, string-based `stop` tokens that can prematurely truncate responses, as seen in Cycle 44.

The `GPT-OSS` repository introduces a more advanced approach, "Harmony," which uses a vocabulary of special control tokens (e.g., `<|start|>`, `<|channel|>`, `<|message|>`, `<|end|>`) to guide the model's generation into a structured, machine-readable format. This is a significantly more robust and powerful way to handle structured data generation with LLMs.

The goal of this plan is to outline a phased migration from our current XML-based schema to a Harmony-aligned schema for all communication with the vLLM backend.

## 2. Analysis of the Harmony Approach

The `openai_harmony` library and `harmony_vllm_app.py` demonstrate a sophisticated workflow:

1.  **Structured Prompt Rendering:** Instead of a single block of text, the prompt is constructed as a series of messages, each with a `role` (system, user, assistant), and potentially a `channel` (analysis, commentary, final). This entire structure is "rendered" into a sequence of tokens that includes the special control tokens.
2.  **Guided Generation:** The model is trained or fine-tuned to understand these control tokens. It learns to "speak" in this format, for example, by placing its internal monologue in an `analysis` channel and its final answer in a `final` channel.
3.  **Robust Parsing:** The response from the model is not just a block of text; it's a stream of tokens that can be parsed deterministically using the same control tokens. A `StreamableParser` can listen to the token stream and identify when the model is opening a new message, writing to a specific channel, or finishing its turn.

This is fundamentally superior to our current regex-based parsing.

## 3. Proposed Migration Plan

This is a major architectural change and should be implemented in phases.

### Phase 1: Adopt Harmony for File Formatting (Immediate)

-   **Goal:** Replace the `<file path="...">` and `