# Artifact A39: DCE - Phase 2 - Cycle Navigator - Technical Plan
# Date Created: C70
# Author: AI Model
# Updated on: C87 (Refine data model and specify cycle bounds logic)

- **Key/Value for A0:**
- **Description:** Details the technical approach for implementing the Cycle Navigator, including data structures for storing cycle-specific responses and the state management for historical navigation.
- **Tags:** feature plan, phase 2, technical plan, architecture, state management, data model

## 1. Overview

This document outlines the technical strategy for implementing the Cycle Navigator and PCPP persistence. The implementation will require a structured data format for storing historical data, enhancements to the frontend state management, new IPC channels, and robust backend logic for data persistence.

## 2. Data Structure and Persistence

A structured approach to storing the historical data is critical. A simple JSON file stored within the workspace's `.vscode` directory is a suitable starting point.

### 2.1. `dce_history.json` (Example)

```json
{
  "version": 1,
  "cycles": [
    {
      "cycleId": 86,
      "timestamp": "2025-08-20T12:30:00Z",
      "title": "ts errors",
      "cycleContext": "Long-term notes about the goal of cycle 86...",
      "ephemeralContext": "<console_log>...</console_log>",
      "responses": {
        "1": "<src/client/views/parallel-copilot.view/view.tsx>...</file>",
        "2": "...",
        "3": ""
      }
    },
    {
      "cycleId": 87,
      "timestamp": "2025-08-21T10:00:00Z",
      "title": "virtuous cycle, phase 2 perfection",
      "cycleContext": "Focus on persistence and diffing.",
      "ephemeralContext": "",
      "responses": {
        "1": "", "2": "", "3": "", "4": ""
      }
    }
  ]
}
```

*   **Backend (`history.service.ts`):** This service will manage reading from and writing to `dce_history.json`. It will handle file locking to prevent race conditions and provide methods like `getCycle(cycleId)`, `saveCycle(cycleData)`, and `getCycleList()`.

## 3. Frontend State Management (`parallel-copilot.view.tsx`)

The main view's state will be expanded to manage the historical context.

```typescript
interface PcppState {
  currentCycleId: number;
  maxCycleId: number;
  cycleTitle: string;
  cycleContext: string;
  ephemeralContext: string;
  tabCount: number;
  activeTab: number;
  tabContent: { [tabId: number]: string };
  // ... other state for diffing, file association, etc.
}
```

*   `currentCycleId` will drive the UI display and data fetching.
*   `maxCycleId` will be determined by the highest cycle number in the history file, preventing the user from navigating into the future. The minimum will be hardcoded to 1.
*   The navigation buttons will increment or decrement `currentCycleId` within the bounds `[1, maxCycleId]`.
*   Changing `currentCycleId` will trigger a `useEffect` hook to request the data for that cycle from the backend.
*   Changes to any text field will trigger a debounced save operation to the backend.

## 4. IPC Communication

New and updated channels are needed to orchestrate the data flow.

*   `ClientToServerChannel.RequestCycleData`:
    *   **Payload:** `{ cycleId: number }`
    *   **Action:** Frontend requests the full data object for a specific cycle from the backend.
*   `ClientToServerChannel.RequestCycleHistoryList`:
    *   **Payload:** `{}`
    *   **Action:** Frontend requests the list of all available cycle IDs to determine the `maxCycleId`.
*   `ClientToServerChannel.SaveCycleData`:
    *   **Payload:** `{ cycleData: Cycle }`
    *   **Action:** Frontend sends the complete state for a cycle to the backend to be persisted.
*   `ServerToClientChannel.SendCycleData`:
    *   **Payload:** `{ cycleData: Cycle | null }` // Can be null if cycle doesn't exist
    *   **Action:** Backend sends the requested cycle data to the frontend.
*   `ServerToClientChannel.SendCycleHistoryList`:
    *   **Payload:** `{ cycleIds: number[] }`
    *   **Action:** Backend sends the list of all cycle IDs.

## 5. Workflow Integration

1.  **On Load:** The Parallel Co-Pilot view requests the full cycle history list. It sets `maxCycleId` to the highest number received (or the current cycle number if history is empty). It then requests the data for the `maxCycleId`.
2.  **On Navigate:** Clicking `<` or `>` changes `currentCycleId`. A `useEffect` hook detects this change and sends `RequestCycleData` to the backend. The backend's `SendCycleData` response triggers a state update that re-renders the entire panel with the historical data.
3.  **On Change:** Any change to a text area (`tabContent`, `cycleContext`, etc.) triggers a debounced function that gathers the entire current UI state into a `Cycle` object and sends it to the backend via `SaveCycleData`. The backend service then finds the corresponding cycle in the JSON file and overwrites it.