# Artifact A110: DCE - Universal Task Checklist for Cycle 81
# Date Created: C81
# Author: AI Model & Curator

## 1. Purpose

This artifact provides a structured checklist for tracking the development tasks and critical bugs identified in Cycle 81. The primary focus is a major refactor of the response generation state management to fix UI disconnects, state persistence failures, and incorrect history status.

---

## Task List for Cycle 81+

## T-1: Consolidate and Persist Generation State (Core Refactor)
- **Files Involved:**
    - `src/common/types/pcpp.types.ts`
    - `src/common/types/vscode-webview.d.ts`
    - `src/backend/services/llm.service.ts`
    - `src/backend/services/history.service.ts`
- **Total Tokens:** ~10,000
- **More than one cycle?** No
- **Status:** To Do

- [ ] **Task (T-ID: 1.1):** In `pcpp.types.ts`, enhance the `TabState` interface to include all generation progress metrics (`startTime`, `thinkingTokens`, `currentTokens`, `totalTokens`). This will be the single source of truth.
- [ ] **Task (T-ID: 1.2):** In `vscode-webview.d.ts`, add a `generationState?: { [key: string]: TabState }` to the `ViewState` interface to define the shape of the persisted state.
- [ ] **Task (T-ID: 1.3):** In `llm.service.ts`, refactor `generateBatch` to construct and persist these comprehensive `TabState` objects via the history service on each data chunk.
- [ ] **Task (T-ID: 1.4):** In `history.service.ts`, create a new `updateTabStateInCycle` method to handle frequent, partial state updates to `dce_history.json`, making it the durable store for generation progress.

### Verification Steps
1.  Initiate a generation.
2.  Inspect `dce_history.json` while generation is in progress.
3.  **Expected:** The `responses` objects for the new cycle should be continuously updated with the latest token counts and status.

## T-2: Fix Frontend Rendering Logic and State Restoration
- **Files Involved:**
    - `src/client/views/parallel-copilot.view/view.tsx`
    - `src/client/views/parallel-copilot.view/components/ResponseTabs.tsx`
    - `src/client/views/parallel-copilot.view/components/GenerationProgressDisplay.tsx`
- **Total Tokens:** ~22,000
- **More than one cycle?** No
- **Status:** To Do

- [ ] **Task (T-ID: 2.1):** In `view.tsx`, eliminate the separate `generationProgress` state. The main `tabs` state will now hold all progress information.
- [ ] **Task (T-ID: 2.2):** Implement `vscode.setState` to save the `tabs` object whenever `UpdateGenerationProgress` is received. Use `vscode.getState` on initial load to restore this state, fixing the persistence bug.
- [ ] **Task (T-ID: 2.3):** Rewrite the main render logic in `view.tsx`. The decision to show `GenerationProgressDisplay` vs. `ResponsePane` must be based *only* on the `status` of the `activeTab`.
- [ ] **Task (T-ID: 2.4):** Refactor `ResponseTabs.tsx`. The spinner should be visible if `tab.status` is `'thinking'` or `'generating'`. File/token counts should *only* be visible if `tab.status === 'complete'`.
- [ ] **Task (T-ID: 2.5):** Update `GenerationProgressDisplay.tsx` to receive the `tabs` object as its source of truth for rendering progress bars.

### Verification Steps
1.  Start a new generation.
2.  **Expected:** Tabs that are generating should show a spinner and NO token counts.
3.  As a tab completes, its spinner should disappear and its token/file count should appear.
4.  Click on a completed tab while others are generating.
5.  **Expected:** The view should switch to the `ResponsePane` for that tab.
6.  Navigate away from the VS Code window and back.
7.  **Expected:** The progress display should reappear in the exact same state it was in before, with timers and progress bars intact.
8.  Once all responses are complete, select any tab.
9.  **Expected:** The view should show the `ResponsePane` for the selected tab, not the progress display.