# Artifact A99: DCE - Response Regeneration Workflow Plan
# Date Created: C50
# Author: AI Model & Curator
# Updated on: C62 (Add per-tab regeneration)

- **Key/Value for A0:**
- **Description:** Details the user stories and technical implementation for the "Regenerate" button in the PCPP, including logic for regenerating empty tabs, all tabs, and a new per-tab refresh feature.
- **Tags:** feature plan, ui, ux, workflow, regeneration

## 1. Vision & Goal

The workflow for generating AI responses needs to be more flexible. Users may decide they need more responses after the initial batch, or a single response might fail to parse or be of low quality. The goal of this feature is to provide intuitive controls for regenerating responses, both globally and individually, without forcing the user to start a new cycle.

## 2. User Stories

| ID | User Story | Acceptance Criteria |
|---|---|---|
| P2-REG-01 | **Regenerate Empty Tabs** | As a user, after increasing the number of response tabs from 4 to 6, I want to click a "Regenerate" button that only generates new responses for the two new, empty tabs, so I don't have to re-generate the ones I already have. | - A global "Regenerate" button exists in the PCPP header. <br> - If one or more response tabs are empty, clicking this button triggers a batch generation request only for the number of empty tabs. <br> - The new responses populate only the empty tabs. |
| P2-REG-02 | **Regenerate All Tabs** | As a user, if all my response tabs have content but I'm unsatisfied with the results, I want to click the "Regenerate" button and be asked if I want to regenerate all responses, so I can start fresh without losing my prompt context. | - If no response tabs are empty, clicking the "Regenerate" button shows a confirmation dialog ("Regenerate all responses?"). <br> - If confirmed, a batch request is sent to generate a full new set of responses, which replaces the content in all existing tabs. |
| P2-REG-03 | **Regenerate a Single Tab** | As a user, if one specific response failed to parse or is very poor, I want a way to regenerate just that single response, so I can try for a better result without affecting the other responses. | - A "Refresh" icon appears on each response tab when hovered. <br> - Clicking this icon triggers a generation request for a single response. <br> - The new response replaces the content of only that specific tab. <br> - The UI for that tab shows a loading indicator while the new response is being generated. |

## 3. Technical Implementation Plan

1.  **IPC Channels:**
    *   The existing `ClientToServerChannel.RequestBatchGeneration` can be reused.
    *   A new `ClientToServerChannel.RequestSingleRegeneration` will be created with a payload of `{ cycleId: number; tabId: string; }`.

2.  **Frontend UI & Logic (`view.tsx`, `ResponseTabs.tsx`):**
    *   **Global "Regenerate" Button (`view.tsx`):**
        *   The `handleRegenerateResponses` function will be implemented.
        *   It will first scan the `tabs` state to find the indices of all empty tabs.
        *   **If empty tabs exist:** It will call the `RequestBatchGeneration` IPC with a `count` equal to the number of empty tabs and a `tabsToRegenerate` array containing their indices.
        *   **If no empty tabs exist:** It will use `vscode.window.showInformationMessage` with "Yes" and "No" options to prompt the user. If "Yes", it will call the IPC with a `count` equal to the total `tabCount`.
    *   **Per-Tab "Refresh" Button (`ResponseTabs.tsx`):**
        *   A new "Refresh" icon button will be added to the tab component, visible on hover.
        *   Its `onClick` handler will trigger the new `RequestSingleRegeneration` IPC message.
        *   The `TabState` in `view.tsx` will be updated to include an `isLoading` flag. This will be used to display a loading spinner on the specific tab being regenerated.

3.  **Backend Logic (`llm.service.ts`, `history.service.ts`):**
    *   **Batch Regeneration:** The backend handlers for `RequestBatchGeneration` will need to be updated to accommodate the `tabsToRegenerate` payload. When the batch responses are received, `history.service.ts` will intelligently update `dce_history.json`, replacing content only for the specified tab IDs.
    *   **Single Regeneration:** A new handler for `RequestSingleRegeneration` will be created.
        *   It will call a new `generateSingle` method in `llm.service.ts`.
        *   It will then call a new `updateSingleResponseInCycle` method in `history.service.ts` to update the specific response in the history file.
        *   A new IPC message will be sent back to the client with the new content for the specific tab.