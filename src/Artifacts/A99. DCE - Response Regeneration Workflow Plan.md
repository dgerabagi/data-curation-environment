# Artifact A99: DCE - Response Regeneration Workflow Plan
# Date Created: C50
# Author: AI Model & Curator
# Updated on: C69 (Refine per-tab regeneration workflow)

- **Key/Value for A0:**
- **Description:** Details the user stories and technical implementation for the "Regenerate" button in the PCPP, including logic for regenerating empty tabs, all tabs, and a new per-tab refresh feature.
- **Tags:** feature plan, ui, ux, workflow, regeneration

## 1. Vision & Goal

The workflow for generating AI responses needs to be more flexible. Users may decide they need more responses after the initial batch, or a single response might fail to parse or be of low quality. The goal of this feature is to provide intuitive controls for regenerating responses, both globally and individually, without forcing the user to start a new cycle.

## 2. User Stories & Button Behaviors

| ID | User Story | Acceptance Criteria |
|---|---|---|
| P2-REG-01 | **Regenerate Empty Tabs** | As a user, after increasing the number of response tabs from 4 to 6, I want to click the global "Regenerate responses" button, which should only generate new responses for the two new, empty tabs. | - A global "Regenerate responses" button exists in the PCPP header. <br> - If one or more response tabs are empty, clicking this button triggers a batch generation request only for the number of empty tabs. <br> - The new responses populate only the empty tabs. |
| P2-REG-02 | **Regenerate All Tabs** | As a user, if all my response tabs have content but I'm unsatisfied, I want to click the global "Regenerate responses" button and be asked if I want to regenerate *all* responses. | - If no response tabs are empty, clicking "Regenerate responses" shows a confirmation dialog. <br> - If confirmed, a batch request is sent to generate a full new set of responses, which replaces the content in all existing tabs. |
| P2-REG-03 | **Regenerate a Single Tab (from Tab View)** | As a user, if one specific response is poor, I want a "Refresh" icon on that tab to regenerate just that single response without affecting others. | - A "Refresh" icon appears on each response tab when hovered. <br> - Clicking this icon triggers a generation request for a single response. <br> - The new response replaces the content of only that specific tab. <br> - **(C69 Update)** The UI for that tab shows a loading indicator while the regeneration is in progress. |
| P2-REG-04 | **Re-generate a Single Response (from Progress View)** | As a user watching responses stream in, if one response seems stuck or is generating poorly, I want a "Re-generate" button next to it to discard the current attempt and start a new one for just that slot. | - In the `GenerationProgressDisplay`, a "Re-generate" button is available for each response. <br> - Clicking it stops the current generation for that response (if active) and immediately initiates a new request for that single response slot. |

## 3. Technical Implementation Plan (C69 Update)

1.  **IPC Channels:**
    *   The existing `ClientToServerChannel.RequestNewCycleAndGenerate` can be used for global regeneration.
    *   A new `ClientToServerChannel.RequestSingleRegeneration` will be created with a payload of `{ cycleId: number; tabId: string; }`.

2.  **Frontend UI & Logic (`view.tsx`, `ResponseTabs.tsx`, `GenerationProgressDisplay.tsx`):**
    *   **Global "Regenerate responses" Button (`view.tsx`):** The logic will be updated to check for empty tabs and prompt for confirmation if none are found.
    *   **Per-Tab "Refresh" Button (`ResponseTabs.tsx`):** This button will trigger the `RequestSingleRegeneration` IPC message.
    *   **Per-Response "Re-generate" Button (`GenerationProgressDisplay.tsx`):** This button will also trigger the `RequestSingleRegeneration` IPC message, passing the `cycleId` and the `responseId` (which corresponds to the tab ID).
    *   **Loading State (`view.tsx`):** An `isLoading` property will be added to the `TabState` interface. When a per-tab regeneration is requested, this will be set to `true` for the corresponding tab, triggering the UI to show a loading spinner. A new IPC message from the backend will signal completion and set `isLoading` back to `false`.

3.  **Backend Logic (`llm.service.ts`, `history.service.ts`, `prompt.service.ts`):**
    *   **Batch Regeneration:** The backend handlers will be updated to accommodate regenerating only specific tabs.
    *   **Single Regeneration (`on-message.ts`):** A new handler for `RequestSingleRegeneration` will be created.
        *   It will retrieve the data for the specified `cycleId`.
        *   **Crucially, it will then retrieve the data for the *previous* cycle (`cycleId - 1`).** This is the correct context to use for generating the prompt, as it was the state that led to the original set of responses.
        *   It will call `promptService.generatePromptString` with the data from the previous cycle.
        *   It will call a new `generateSingle` method in `llm.service.ts` to handle the API call.
        *   It will then call `updateSingleResponseInCycle` in `history.service.ts` to update the specific response in the history file.
        *   It will send a message back to the client to signal completion.