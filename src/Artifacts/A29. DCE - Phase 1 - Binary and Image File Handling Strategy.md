# Artifact A29: DCE - Phase 1 - Binary and Image File Handling Strategy
# Date Created: C46
# Author: AI Model

- **Key/Value for A0:**
- **Description:** Defines the strategy for handling binary files; they can be checked, but only their metadata (path, size) is included in the flattened output, not their content.
- **Tags:** feature plan, binary, image, metadata, flatten, phase 1

## 1. Overview & Goal

During beta testing, a use case emerged for including information about binary files (like images) in the flattened context without including their raw, unreadable content. The goal of this strategy is to allow users to select *any* file, but to intelligently handle non-text files during the flattening process to prevent corrupting the output while still capturing useful metadata.

## 2. Problem Statement

-   **Initial Problem:** Flattening a folder containing images (`.png`, `.gif`) resulted in binary gibberish being written to `flattened_repo.md`.
-   **Initial Solution (C43):** Prevent selection of binary files by disabling their checkboxes.
-   **Refined Requirement (C46):** The user realized they *do* want to capture the existence and properties of these files (e.g., path, size) as part of the context, just not their content.

## 3. The New Strategy

The extension will now adopt a "metadata-only" approach for a predefined list of binary and image file types.

### 3.1. User Experience

1.  **Selection is Always Allowed:** All files in the file tree, regardless of type, will have an enabled checkbox. The user is free to check any file or folder.
2.  **Flattening Behavior is Differentiated:**
    *   When a **text file** is checked and the "Flatten Context" button is pressed, its full content is read and included in `flattened_repo.md`.
    *   When a **binary or image file** is checked, its content is **not** read. Instead, the flattener service will gather its metadata and include a structured, human-readable entry for it in `flattened_repo.md`.

### 3.2. Output Format for Binary Files

When a binary file is included, its entry in the `<files content>` section of `flattened_repo.md` will look like this:

```xml
<file path="docs/assets/screenshot.png">
<metadata format="PNG" sizeInBytes="4340" />
</file>
```

This format is clean, parseable, and provides the necessary context without including corrupting data.

## 4. Technical Implementation Plan

1.  **Frontend Simplification:**
    *   The `isSelectable` property will be removed from the `FileNode` type (`src/common/types/file-node.ts`).
    *   The logic in `fs.service.ts` that determines `isSelectable` will be removed.
    *   The `disabled` attribute on the `Checkbox` in `FileTree.tsx` will be removed.

2.  **Backend Flattener Logic (`flattener.service.ts`):**
    *   A constant set of binary/image extensions (e.g., `.png`, `.jpg`, `.gif`, `.webp`, `.pdf`, `.zip`) will be defined.
    *   The `getFileStatsAndContent` method will be updated. Before attempting to read a file, it will check the file's extension against the binary list.
    *   If it's a binary file, it will:
        *   Use `fs.stat` to get the `sizeInBytes`.
        *   Construct the `<metadata ... />` string.
        *   Return a `FileStats` object where `content` is this metadata string, and `tokens` is 0.
    *   If it's a text file, the existing logic of reading content and calculating tokens will proceed as normal.