# Artifact A53: DCE - Phase 2 - Token Count and Similarity Analysis
# Date Created: C111
# Author: AI Model & Curator

- **Key/Value for A0:**
- **Description:** Details the plan to implement token counting for raw and parsed responses, and to calculate a similarity score between AI-generated files and their workspace originals.
- **Tags:** feature plan, phase 2, token count, similarity, metrics, ui, ux

## 1. Overview & Goal

To enhance the curator's decision-making process, the Parallel Co-Pilot Panel (PCPP) must provide quantitative metrics about the AI's responses. The goal of this feature is to display token counts for various pieces of content and a similarity score to gauge the extent of changes proposed by the AI. This allows the user to quickly assess response verbosity, parser effectiveness, and the magnitude of code modifications.

## 2. User Stories

| ID | User Story | Acceptance Criteria |
|---|---|---|
| P2-MET-01 | **Raw Response Token Count** | As a user, I want to see the total token count of the raw AI response I've pasted, so I can understand the overall size of the output. | - A token count is displayed for the raw content in each response tab. <br> - This count updates in real-time as I type or paste content. |
| P2-MET-02 | **Parsed vs. Original Token Count** | As a user, when viewing a parsed file, I want to see a comparison of the token count between the original workspace file and the AI's new version, so I can quickly see if the code is growing or shrinking. | - In the header of the code viewer pane, the token counts for both the original and new versions of the selected file are displayed (e.g., "Original: 4.1K | New: 4.2K"). |
| P2-MET-03 | **File Similarity Score** | As a user, along with the token counts, I want to see a percentage-based similarity score, so I can gauge how substantially the AI has altered the file. | - A similarity score (e.g., "Sim: 98%") is displayed in the code viewer header. <br> - A score of 100% indicates identical files. <br> - A low score indicates a major rewrite. |

## 3. Technical Implementation Plan

### Phase 1: UI Placeholders (Current Cycle)

1.  **`parallel-copilot.view/view.tsx`:**
    *   Add placeholder elements in the UI to display the token counts and similarity score.
    *   Raw response token count: Calculate and display this on the frontend via `rawContent.length / 4`.
    *   Parsed file metrics: Display static placeholder text in the code viewer header.

### Phase 2: Backend Logic & Integration (Future Cycle)

1.  **New IPC Channel:**
    *   Create `ClientToServerChannel.RequestFileComparison`.
    *   Payload: `{ filePath: string; modifiedContent: string; }`.
    *   Response channel: `ServerToClientChannel.SendFileComparison`.
    *   Payload: `{ originalTokens: number; modifiedTokens: number; similarity: number; }`.

2.  **Backend (`fs.service.ts`):**
    *   Implement `handleFileComparisonRequest`.
    *   It will read the content of the original `filePath` from the workspace.
    *   It will calculate the token count for the original content.
    *   It will calculate the token count for the `modifiedContent` received in the payload.
    *   It will compute a similarity score. A simple and effective algorithm for this is the **SÃ¸rensen-Dice coefficient** on sets of n-grams (e.g., 2-grams) from each string.
    *   It will send the results back to the client via `SendFileComparison`.

3.  **Frontend (`parallel-copilot.view/view.tsx`):**
    *   When a file is selected for viewing (`setSelectedFilePath`), send the `RequestFileComparison` message.
    *   Create new state variables to hold the comparison results: `const [comparisonMetrics, setComparisonMetrics] = useState(null);`.
    *   The message handler for `SendFileComparison` will update this state.
    *   The UI will be updated to render the live data from the `comparisonMetrics` state instead of the placeholders.