# Artifact A97: DCE - vLLM Response Progress UI Plan
# Date Created: C48
# Author: AI Model & Curator
# Updated on: C68 (Refine sort behavior)

- **Key/Value for A0:**
- **Description:** A plan and textual mockup for a UI to display the progress of incoming vLLM responses, including color-coded progress bars, status indicators, timers, and a manual "View Responses" button.
- **Tags:** feature plan, ui, ux, vllm, progress indicator, metrics, streaming, sse

## 1. Vision & Goal

Generating multiple, large AI responses can take a significant amount of time. To improve the user experience, it's critical to provide clear, real-time feedback that the system is working and to show the progress of the generation. The goal of this feature is to create a dedicated UI that appears during response generation, displaying progress bars, status indicators, performance metrics, and timing information for each parallel response.

## 2. User Stories

| ID | User Story | Acceptance Criteria |
|---|---|---|
| P3-PROG-01 | **See Generation Progress** | As a user, when I click "Generate responses," I want a UI to immediately appear that shows me the progress of each response being generated, so I know the system is working and not frozen. | - When generation starts, a progress display UI is shown. <br> - It contains a separate progress bar for each of the `N` requested responses. <br> - Each progress bar updates in real-time as tokens are received. |
| P3-PROG-02 | **See Performance Metrics** | As a user, I want to see a live "tokens per second" metric during generation, so I can gauge the performance of the LLM backend. | - The progress UI displays a "Tokens/sec" value. <br> - This value is calculated and updated periodically throughout the generation process. |
| P3-PROG-03 | **Understand Progress Bar**| As a user, I want the progress bar to be color-coded so I can understand the allocation of tokens for the prompt versus the generated response. | - The progress bar is a stacked bar with multiple colors. <br> - One color represents the "thinking" (prompt) tokens. <br> - A second color represents the currently generated response tokens. <br> - A third color (gray) represents the remaining, unused tokens up to the model's maximum. |
| P3-PROG-04 | **See Response Status** | As a user, I want to see the status of each individual response (e.g., "Thinking...", "Generating...", "Complete"), so I know what the system is doing. | - A text indicator next to each progress bar shows its current status. <br> - The indicator is animated during the "Thinking" and "Generating" phases. <br> - When a response is complete, the "unused" portion of its progress bar changes color to signify completion. |
| P3-PROG-05 | **See Unused Tokens** | As a user, once a response is complete, I want to see how many tokens were left unused, so I can understand how much headroom the model had. | - After a response's status changes to "Complete", a text element appears showing the count of unused tokens. |
| P3-PROG-06 | **Manage Responses** | As a user, I want to sort responses, stop a generation, or re-generate an individual response, so I have more control over the process. | - A sort button cycles through different sort orders. <br> - A "Stop" button for each response cancels its generation. <br> - A "Re-generate" button for each response triggers a new generation just for that slot. |
| P3-PROG-07 | **See Elapsed Time** | As a user, I want to see a timer showing the total elapsed time for the generation, so I can understand how long the process is taking. | - A master timer is displayed in the header. <br> - Each response can display its own timing information (e.g., time to first token). |
| P3-PROG-08 | **Review Metrics Before Navigating** | As a user, after all responses are complete, I want to stay on the progress screen to review the final metrics, and then click a button to navigate to the new cycle, so I am in control of the workflow. | - When generation finishes, the UI does not automatically navigate away. <br> - A "View Responses" button appears. <br> - A completion counter (e.g., "4/4 Responses Complete") is displayed. |
| P3-PROG-09 | **Three-Way Sorting** | As a user, I want the sort button to cycle between three states: the default order, sorting by total tokens (thinking + response), and sorting by response tokens only, so I can analyze the results in different ways. | - The sort button cycles through three distinct states. <br> - The UI re-orders the list of responses accordingly. |

## 3. UI Mockup (Textual Description - C63 Update)

The progress UI will be a dedicated component that is conditionally rendered in the PCPP view when `isGenerating` is true.

```
+----------------------------------------------------------------------+
| Generating Responses... [Sort by Total Tk] Tokens/sec: 1234 | 00:45.3  |
|----------------------------------------------------------------------|
| Total Tokens: 18,120                                                 |
|                                                                      |
| Resp 1: [blue|green|gray]  80% | Status: Generating... [Stop] [Re-gen]|
|         (1k+5.5k/8.1k tk)      | TTFT: 1.2s                           |
| Resp 2: [blue|green|gray]  70% | Status: Generating... [Stop] [Re-gen]|
|         (1k+4.7k/8.1k tk)      | TTFT: 1.5s                           |
| Resp 3: [blue|gray      ]  12% | Status: Thinking...   [Stop] [Re-gen]|
|         (1k+0k/8.1k tk)        |                                      |
| Resp 4: [blue|green|done] 100% | Status: Complete âœ“    [     ] [Re-gen]|
|         (1k+7.1k/8.1k tk)      | Unused: 1,024 tk | Total Time: 35.8s |
|----------------------------------------------------------------------|
| [ 4/4 Responses Complete ]           [ View Responses ]              |
+----------------------------------------------------------------------+
```
*   **Header:** The "Sort" button is co-located with the TPS metric. A master elapsed timer is on the far right.
*   **Per-Response:**
    *   Stop/Regen buttons are on the same row as the status.
    *   A "Time to First Token" (TTFT) or other phase timer is displayed.
*   **Footer:** Appears only when generation is complete. Shows a completion counter and the button to navigate to the new cycle.

## 4. Technical Implementation Plan (C68 Revision)

1.  **IPC (`channels.type.ts`):** The `GenerationProgress` interface will be updated to include timing information, such as `startTime`, `firstTokenTime`, and `endTime` (as timestamps).
2.  **Backend (`llm.service.ts`):** The `generateBatch` method will be updated to record timestamps at each stage of the streaming process and include them in the `UpdateGenerationProgress` payload. The `AbortController` will be used to make the "Stop" functionality work.
3.  **Frontend (`GenerationProgressDisplay.tsx` & `view.scss`):**
    *   **Layout:** The JSX will be refactored to move the buttons to their new locations. All buttons will receive a consistent style class.
    *   **Timer Logic:** The component will receive the timestamps from the backend. A `useEffect` hook with a `setInterval` will be used to calculate and display the main elapsed timer.
    *   **Completion State:** The component will receive an `isGenerationComplete` prop. When true, it will render the new footer with the completion counter and the "View Responses" button.
    *   **Sorting Logic:** A new state `sortMode: 'default' | 'total' | 'response'` will be added. The sort button will cycle through these values. A `useMemo` hook will re-sort the `progressData` array based on the active `sortMode`.
    *   **Color-Coding:** Spans with specific classes will be added around the token count text elements for individual styling.
4.  **Frontend (`view.tsx`):** The message handler for `SendBatchGenerationComplete` will no longer trigger navigation. Instead, it will set an `isGenerationComplete` state variable to `true`. A new handler function for the "View Responses" button will be created to handle the navigation.