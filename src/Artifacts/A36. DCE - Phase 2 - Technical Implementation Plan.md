# Artifact A36: DCE - Phase 2 - Technical Implementation Plan
# Date Created: C69
# Author: AI Model
# Updated on: C134 (Add logic for clearing selection state and stricter new cycle button)

- **Key/Value for A0:**
- **Description:** Details the technical approach for building the Parallel Co-Pilot Panel, including the new webview provider, state management, IPC channels, and backend logic for file content swapping.
- **Tags:** feature plan, phase 2, technical plan, architecture, webview, ipc, parsing, markdown, diff

## 1. Overview

This document outlines the technical implementation strategy for the Parallel Co-Pilot Panel. The plan is updated to reflect several UI/UX fixes and new features from Cycle 134.

## 2. Core Components

### 2.1. Frontend State Management (`view.tsx`)

The component state will be expanded to manage the new UI features.

```typescript
// State within the view.tsx component
interface PcppState {
  // ... existing state
  selectedFilesForReplacement: Set<string>;
}```
*   **`selectedFilesForReplacement`**: This state must be explicitly cleared when the user navigates to a new or different cycle to prevent "state bleeding."

### 2.2. Robust "New Cycle" Button Logic

*   **Goal:** The `[ + ]` (New Cycle) button must be disabled until all required precursor data from the *previous* cycle is present.
*   **Implementation (`view.tsx`):** The `isNewCycleButtonDisabled` memoized boolean will be updated. It must now check:
    1.  That the `cycleTitle` of the *current* cycle is non-default and not empty.
    2.  That the `cycleContext` of the *current* cycle is not empty.
    3.  That a `selectedResponseId` has been set for the *current* cycle.
    *   This ensures that a user cannot create an orphaned "Cycle 2" before they have finished providing all the necessary inputs for "Cycle 1".

### 2.3. Clearing Selection State on Navigation

*   **Goal:** Fix the bug where checked files from one cycle remain checked when viewing another cycle.
*   **Implementation (`view.tsx`):**
    1.  In the `handleCycleChange` function, after saving the current state and before requesting the new cycle's data, add a line to reset the selection: `setSelectedFilesForReplacement(new Set());`.
    2.  In the `handleNewCycle` function, also add `setSelectedFilesForReplacement(new Set());`.
    3.  This ensures that every time the cycle context changes, the local UI state for file selections is reset to a clean slate.

### 2.4. Backend File Existence & Content (`fs.service.ts`)

*   **Status:** No changes required for this cycle. The existing plan for smarter path resolution and content fetching remains valid.

### 2.5. IPC Channel Updates

*   **New Channel (`RequestLogState`):** A new channel will be added to facilitate the "Log State" feature.
    *   **Payload:** `{ currentState: PcppCycle }` - The frontend will send its entire current state object.

### 2.6. Backend State Logging (`prompt.service.ts`)

*   **Goal:** Implement the logic for the "Log State" button.
*   **Implementation:**
    1.  A new method, `generateStateLog(currentState: PcppCycle)`, will be added to the `PromptService`.
    2.  It will receive the full frontend state as an argument.
    3.  It will call `Services.historyService.getFullHistory()` to get the historical data.
    4.  It will reuse the existing prompt-generation logic to build the `<M6. Cycles>` string based on the provided `currentState` and the history.
    5.  It will create a second string containing a formatted JSON dump of the `currentState` and the full history.
    6.  It will combine these two strings into a single log message and send it to `Services.loggerService.log()`.