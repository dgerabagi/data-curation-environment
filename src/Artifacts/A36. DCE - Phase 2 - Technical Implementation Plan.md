# Artifact A36: DCE - Phase 2 - Technical Implementation Plan
# Date Created: C69
# Author: AI Model
# Updated on: C88 (Add plan for metadata and diff view state)

- **Key/Value for A0:**
- **Description:** Details the technical approach for building the Parallel Co-Pilot Panel, including the new webview provider, state management, IPC channels, and backend logic for file content swapping.
- **Tags:** feature plan, phase 2, technical plan, architecture, webview, ipc

## 1. Overview

This document outlines the technical implementation strategy for the Parallel Co-Pilot Panel. It involves creating a new, dedicated webview in its own activity bar container and the associated backend services to manage its state and perform file operations.

## 2. Core Components

### 2.1. New View Container & Webview Provider (`package.json`)

*   The `contributes` section of `package.json` will be modified to create a new, independent panel.
*   A new entry will be added to `contributes.viewsContainers.activitybar` to define the container for the Parallel Co-Pilot.
*   A new entry will be added to `contributes.views` to place the webview inside the new container.

### 2.2. Frontend State Management (`view.tsx`)

The main state for the webview will be a single, comprehensive object.

```typescript
interface TabState {
  id: number;
  content: string;
  detectedFiles: string[];
  // Future: annotations, ratings, etc.
}

interface PcppState {
  // ... state for cycle nav, context fields, etc.
  tabs: { [tabId: number]: TabState };
  fileExistence: { [path: string]: boolean };
  
  // New state for managing the diff view
  diffTarget: {
    path: string;
    originalContent: string;
    modifiedContent: string;
  } | null;

  // New state for metadata
  metadata: {
      [tabId: number]: {
          tokenCount: number;
          similarityScore: number;
      }
  }
}
```

*   **Diff View Logic:** When a user clicks a file to diff, the `diffTarget` state is populated. The main render function will have a condition: `if (diffTarget) { render DiffViewer } else { render FileBlocks }`. This handles swapping the main view area.
*   **Metadata Logic:** Similarity scores and token counts will be calculated in `useEffect` hooks that watch for changes in `tabContent`. The results will be stored in the `metadata` state object.

### 2.3. IPC Communication

New and updated channels will be required.

*   `ClientToServerChannel.RequestFileContent`:
    *   **Payload:** `{ path: string }`
    *   **Action:** Frontend requests the content of a source file from the backend for diffing.
*   `ClientToServerChannel.RequestSwapFileContent`:
    *   **Payload:** `{ path: string, newContent: string }`
    *   **Action:** Frontend requests the backend to perform the "swap" operation.
*   `ServerToClientChannel.SendFileContent`:
    *   **Payload:** `{ path: string, content: string | null }` // Null if file not found
    *   **Action:** Backend sends the requested file content back to the frontend.

### 2.4. Backend Logic (`fs.service.ts`)

New handlers will be added to `FSService`.

1.  **`handleFileContentRequest` (New):**
    *   Receives a file path.
    *   Reads the file using `vscode.workspace.fs.readFile`.
    *   Handles errors gracefully if the file doesn't exist.
    *   Returns the content (or `null`) via the `SendFileContent` IPC channel.

2.  **`handleSwapFileContentRequest`:**
    *   This is the core of the "swap" feature.
    *   **Input:** `{ path: string, newContent: string }`.
    *   **Steps:**
        1.  Reads the current content of the file at `path` into a variable (`originalContent`).
        2.  Writes `newContent` to the file at `path` using `vscode.workspace.fs.writeFile`.
        3.  Returns `originalContent` to the frontend via the `SendFileContent` channel.
    *   This single, atomic operation ensures the swap is clean and the original content is immediately sent back to be stored in the tab.

### 2.5. Similarity Scoring

*   A lightweight string similarity library (e.g., `diff` library's functions) will be used on the frontend.
*   A utility function will be created: `calculateSimilarity(stringA, stringB): number`.
*   This calculation will be performed in the frontend whenever the content of a tab changes, and the result stored in the tab's metadata state.