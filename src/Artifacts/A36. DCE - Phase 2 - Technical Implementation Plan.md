# Artifact A36: DCE - Phase 2 - Technical Implementation Plan
# Date Created: C69
# Author: AI Model
# Updated on: C95 (Add plan for diff view and enhanced parsing)

- **Key/Value for A0:**
- **Description:** Details the technical approach for building the Parallel Co-Pilot Panel, including the new webview provider, state management, IPC channels, and backend logic for file content swapping.
- **Tags:** feature plan, phase 2, technical plan, architecture, webview, ipc, parsing, markdown, diff

## 1. Overview

This document outlines the technical implementation strategy for the Parallel Co-Pilot Panel. The plan is updated to reflect a two-pane UI for diffing, a smarter parser, and more resilient backend path resolution.

## 2. Core Components

### 2.1. Frontend State Management (`view.tsx`)

The component state will be expanded to manage the new diffing UI.

```typescript
// State within the view.tsx component
interface PcppState {
  // ... existing state
  isParsedMode: boolean;
  fileExistenceMap: Map<string, boolean>;
  
  // NEW for Diffing
  diffTarget: ParsedFile | null; // The AI-generated file currently being diffed
  originalFileContent: string | null; // The content of the workspace file for comparison
}
```
*   **`diffTarget`**: When a user clicks a file in the "Associated Files" list, this state will be populated with the `ParsedFile` object from the AI response.
*   **`originalFileContent`**: After the backend sends the workspace file's content, this state will be populated, triggering the rendering of the `DiffViewer`.

### 2.2. Frontend Parsing & Path Resolution (`response-parser.ts`)

*   **Enhanced Parser:** The `parseResponse` function will be updated.
    1.  It will first attempt to find file paths using a new regex that looks for paths within angle brackets: `/<([\w\/\.-]+)>/g`. This handles `<src/main.ts>` style tags.
    2.  If that fails, it will fall back to the existing logic of parsing the "Files Updated This Cycle" list. This makes the parser more robust.

### 2.3. Backend File Existence & Content (`fs.service.ts`)

*   **Smarter Path Resolution:** The `handleFileExistenceRequest` method will be enhanced.
    *   If it receives a path that starts with `A` and a number (e.g., `A36. ... .md`) and fails to find it at the workspace root, it will automatically prepend `src/Artifacts/` and try again. This makes it resilient to incomplete doc artifact paths.
*   **New IPC Handler (`handleFileContentRequest`):**
    *   This handler will be implemented to service the new `RequestFileContent` channel.
    *   It will receive a file path, read the file using `vscode.workspace.fs.readFile`, convert the buffer to a string, and send it back in the `SendFileContent` message. It will handle errors gracefully if the file cannot be read.

### 2.4. IPC Channel Updates

*   **New Channel (`RequestFileContent`):**
    *   **Direction:** Client -> Server
    *   **Payload:** `{ path: string }`
*   **New Channel (`SendFileContent`):**
    *   **Direction:** Server -> Client
    *   **Payload:** `{ path: string, content: string | null }` (`null` on error)

### 2.5. Frontend UI Flow for Diffing (`view.tsx`)

1.  User clicks a file in the `AssociatedFilesList` component.
2.  The `onClick` handler calls a new function, e.g., `handleSelectForDiff(file: ParsedFile)`.
3.  `handleSelectForDiff` does two things:
    *   Sets the `diffTarget` state to the clicked `file`.
    *   Sends a `RequestFileContent` IPC message to the backend with `file.path`.
4.  The frontend listens for the `SendFileContent` message. When the message for the correct path arrives, its handler sets the `originalFileContent` state.
5.  The main render function has a condition: `if (diffTarget && originalFileContent)`. When true, it renders the `<DiffViewer original={originalFileContent} modified={diffTarget.content} />` component in the right-hand pane.