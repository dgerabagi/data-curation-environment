# Artifact A36: DCE - Phase 2 - Technical Implementation Plan
# Date Created: C69
# Author: AI Model
# Updated on: C91 (Add plan for global parse toggle and file existence check)

- **Key/Value for A0:**
- **Description:** Details the technical approach for building the Parallel Co-Pilot Panel, including the new webview provider, state management, IPC channels, and backend logic for file content swapping.
- **Tags:** feature plan, phase 2, technical plan, architecture, webview, ipc, parsing, markdown

## 1. Overview

This document outlines the technical implementation strategy for the Parallel Co-Pilot Panel. The plan is updated to reflect two major changes: a global parse/un-parse toggle and a new "Associated Files" list with backend-driven file existence validation.

## 2. Core Components

### 2.1. Frontend State Management (`view.tsx`)

The main component state will be refactored to handle the global view mode.

```typescript
// State within the view.tsx component
interface PcppState {
  // ... state for cycle nav, context fields, tabs, etc.
  isParsedMode: boolean; // NEW: Global toggle for all tabs
  fileExistenceMap: Map<string, boolean>; // NEW: Caches file existence status
  // ... collapsible section states
}

interface TabState {
    rawContent: string;
    parsedContent: ParsedResponse | null;
}
```
*   **Global Parse State:** A new `isParsedMode` boolean will control the rendering of all tabs. The main toolbar button will toggle this state.
*   **File Existence Cache:** A new `Map` will store the results from the backend about whether a file path exists.
*   **Parsing on Demand:** The `onClick` handler for the "Parse All" button will iterate through the `tabs` state object. For any tab where `rawContent` exists but `parsedContent` is `null`, it will call the `parseResponse` utility and update that tab's state.

### 2.2. Frontend Rendering & Logic (`view.tsx`)

1.  **Associated Files List:**
    *   After parsing a response, the frontend will collect all unique file paths from all tabs.
    *   It will send a single `RequestFileExistence` IPC message to the backend with this aggregated list of paths.
    *   An IPC listener for `SendFileExistence` will update the `fileExistenceMap` state.
    *   A new `AssociatedFilesList` component will be rendered in each tab's parsed view. It will receive the `parsedContent.filesUpdated` array and the `fileExistenceMap` as props. It will then render the list with the correct status icons (`✓`/`✗`).

2.  **Markdown & Syntax Highlighting:**
    *   This implementation remains the same as in C90. `react-markdown` will render the plan sections, and `@wooorm/starry-night` on the backend will provide HTML for syntax-highlighted code blocks.

### 2.3. Backend File Existence Check (`fs.service.ts`)

*   **New IPC Handler:** A new handler, `handleFileExistenceRequest`, will be implemented.
*   **Logic:**
    1.  It will receive an array of file paths: `{ paths: string[] }`.
    2.  It will iterate through the paths. For each path, it will use `vscode.workspace.fs.stat(vscode.Uri.file(path))` inside a `try...catch` block.
    3.  It will build a result map: `existenceMap: { [path: string]: boolean }`. If `stat` succeeds, the value is `true`; if it throws an error (e.g., `ENOENT`), the value is `false`.
    4.  It will send this map back to the client via the `SendFileExistence` IPC channel.

### 2.4. IPC Channel Updates

*   **New Channel (`RequestFileExistence`):**
    *   **Direction:** Client -> Server
    *   **Payload:** `{ paths: string[] }`
*   **New Channel (`SendFileExistence`):**
    *   **Direction:** Server -> Client
    *   **Payload:** `{ existenceMap: { [path: string]: boolean } }`