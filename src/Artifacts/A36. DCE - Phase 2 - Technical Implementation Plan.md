# Artifact A36: DCE - Phase 2 - Technical Implementation Plan
# Date Created: C69
# Author: AI Model
# Updated on: C96 (Add persistent parse mode and robust new cycle logic)

- **Key/Value for A0:**
- **Description:** Details the technical approach for building the Parallel Co-Pilot Panel, including the new webview provider, state management, IPC channels, and backend logic for file content swapping.
- **Tags:** feature plan, phase 2, technical plan, architecture, webview, ipc, parsing, markdown, diff

## 1. Overview

This document outlines the technical implementation strategy for the Parallel Co-Pilot Panel. The plan is updated to reflect a two-pane UI for diffing, a smarter parser, more resilient backend path resolution, and several UI/UX fixes from Cycle 96.

## 2. Core Components

### 2.1. Frontend State Management (`view.tsx`)

The component state will be expanded to manage the new UI features.

```typescript
// State within the view.tsx component
interface PcppState {
  // ... existing state
  tabCount: number; // New: To control the number of response tabs
  isParsedMode: boolean;
  fileExistenceMap: Map<string, boolean>;
  diffTarget: ParsedFile | null;
  originalFileContent: string | null;
  // New: Separate state for each collapsible section
  isCycleCollapsed: boolean;
  isSummaryCollapsed: boolean;
  isCourseOfActionCollapsed: boolean;
  isAssociatedFilesCollapsed: boolean;
}
```
*   **`tabCount`**: A new state to control the number of tabs rendered.
*   **Collapsible States**: New booleans to manage the UI state for each collapsible section independently.

### 2.2. Persistent "Parsed Mode"

*   **Goal:** The `isParsedMode` state should be "sticky." If the user is in parsed mode and navigates to another cycle, the new cycle's content should be automatically parsed and displayed.
*   **Implementation:**
    1.  **Backend (`history.service.ts`):** The `PcppCycle` interface will be updated to include `isParsedMode: boolean`.
    2.  **Frontend (`view.tsx`):**
        *   The `saveCurrentCycleState` function will be updated to include the current `isParsedMode` in the data sent to the backend.
        *   When loading a cycle (either the latest or via navigation), the `isParsedMode` state will be restored from the loaded `cycleData`.
        *   A `useEffect` hook will listen for changes to the loaded cycle data. If `isParsedMode` is true after the data loads, it will automatically trigger the parsing logic for all tabs.

### 2.3. Robust "New Cycle" Button Logic

*   **Goal:** The `[ + ]` (New Cycle) button must be disabled if no meaningful content has been added to the current cycle.
*   **Implementation (`view.tsx`):** The `disabled` property of the button will be controlled by a memoized boolean:
    ```typescript
    const isNewCycleButtonDisabled = useMemo(() => {
        const hasTitle = cycleTitle && cycleTitle !== 'New Cycle';
        const hasContext = cycleContext || ephemeralContext;
        const hasResponseContent = Object.values(tabs).some(tab => tab.rawContent.trim());
        return !hasTitle && !hasContext && !hasResponseContent;
    }, [cycleTitle, cycleContext, ephemeralContext, tabs]);
    ```

### 2.4. Backend File Existence & Content (`fs.service.ts`)

*   **Status:** No changes required for this cycle. The existing plan for smarter path resolution and content fetching remains valid.

### 2.5. IPC Channel Updates

*   **Status:** No new channels required for this cycle.

### 2.6. Frontend UI Flow for Diffing (`view.tsx`)

*   **Goal:** Fix the non-functional diff view.
*   **Implementation:**
    1.  Add detailed `logger.log()` statements to the `handleSelectForDiff` function to confirm it is being called on click.
    2.  Log the `file.path` being sent over `RequestFileContent`.
    3.  Add logging to the `onmessage` handler for `SendFileContent` to confirm a response is received from the backend.
    4.  Log the state variables (`diffTarget`, `originalFileContent`) just before the component's `return` statement to verify they are being set correctly. This will isolate the point of failure.