# Artifact A44: DCE - Phase 1 - Word Document Handling Strategy
# Date Created: C73
# Author: AI Model

- **Key/Value for A0:**
- **Description:** Defines the strategy for handling Word document files (.docx) by converting them to text on-demand and caching them in memory for flattening.
- **Tags:** feature plan, docx, text extraction, virtualization, cache, phase 1

## 1. Overview & Goal

To further expand the data curation capabilities of the extension, users need to be able to include the content of Microsoft Word documents (`.docx`). Following the successful virtualization pattern used for PDFs and Excel files, the goal is to extract text from Word documents on-demand and hold it in an in-memory cache. This allows their content to be included in the flattened context without creating temporary files in the user's workspace.

**Note on file formats:** This strategy will initially focus on the modern `.docx` format. The legacy binary `.doc` format is significantly more complex to parse and support for it will be deferred.

## 2. User Stories

| ID | User Story | Acceptance Criteria |
|---|---|---|
| DOCX-01 | **Include Word Document Text in Context** | As a user, when I check a `.docx` file, I want its text content to be extracted and included in the `flattened_repo.md`, so I can use reports and documents as context for the LLM. | - Checking `.docx` files is allowed. <br> - The token count displayed for the file reflects its extracted text content. <br> - When flattened, the text from the document is included within a `<file>` tag. <br> - No temporary files are created in the user's workspace. |

## 3. Technical Implementation Plan

1.  **Dependency:**
    *   The `mammoth` library will be added to `package.json`. It is a popular and effective library for converting `.docx` files to HTML and raw text.

2.  **Backend (`fs.service.ts`):**
    *   **In-Memory Cache:** A new private cache will be added: `private wordTextCache = new Map<string, { text: string; tokenCount: number }>();`.
    *   **New IPC Handler (`RequestWordToText`):**
        *   This handler will receive a file path for a `.docx` file.
        *   It will first check the `wordTextCache`.
        *   If not cached, it will read the file buffer.
        *   It will use `mammoth.extractRawText({ buffer })` to get the plain text content.
        *   It will calculate the token count, store the result in the cache, and then return it.
        *   It will send an `UpdateNodeStats` message back to the client with the new token count.

3.  **Frontend (`view.tsx`):**
    *   **On-Demand Extraction:** The main `updateCheckedFiles` function will be modified. When a path ending in `.docx` is checked for the first time, it will send a `RequestWordToText` message to the backend.

4.  **Backend (`flattener.service.ts`):**
    *   **Virtual Content Retrieval:** The `getFileStatsAndContent` method will be updated.
    *   If it encounters a file path ending in `.docx`, it will retrieve the text from the `wordTextCache` in the `FSService` instead of reading the binary file.

5.  **UI & Configuration:**
    *   **IPC:** A new `ClientToServerChannel.RequestWordToText` will be added.
    *   **File Node:** The `FileNode` type will be updated with an `isWordDoc` flag.
    *   **Icon (`FileTree.tsx`):** A suitable icon for Word documents will be added to the `getFileIcon` utility.