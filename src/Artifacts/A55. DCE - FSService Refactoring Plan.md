# Artifact A55: DCE - FSService Refactoring Plan
# Date Created: C113
# Author: AI Model & Curator
# Updated on: C114 (Mark refactor as complete)

- **Key/Value for A0:**
- **Description:** Outlines a strategic plan to refactor the monolithic `FSService` into smaller, more focused services to improve modularity, maintainability, and reduce token count.
- **Tags:** refactor, architecture, technical debt, services

## 1. Problem Statement

The `FSService` has become a "god object," handling a wide range of responsibilities beyond basic file system interactions and now violates the Single Responsibility Principle. Its large size (over 800 lines) makes it difficult to maintain, debug, and reason about. The service currently manages at least four distinct areas of concern:
1.  **Workspace State:** Building, caching, and watching the file tree.
2.  **File Operations:** Handling requests to create, move, delete, and modify files.
3.  **Content Virtualization:** Processing special file types like PDF, Word, and Excel into text.
4.  **Syntax Highlighting:** Managing the `starry-night` library and processing highlighting requests.

## 2. Refactoring Plan (Completed in C114)

The `FSService` has been successfully broken down into four new, more focused services. This has improved code organization, reduced the token count of individual files, and made the system more modular and maintainable.

### 2.1. New Service Structure

#### 1. `FileTreeService`
-   **Responsibility:** All "read" operations related to the workspace structure. This service is the source of truth for what the workspace looks like.
-   **Methods moved here:**
    -   `handleWorkspaceFilesRequest`
    -   `buildTreeFromTraversal`, `_traverseDirectory`, `_aggregateStats`
    -   `getFileStats`
    -   `getGitStatusMap`, `getProblemCountsMap`
    -   `initializeWatcher`, `triggerFullRefresh`, `triggerDiagnosticsUpdate`
    -   `fileTreeCache` property

#### 2. `FileOperationService`
-   **Responsibility:** All "write" or direct modification operations on the file system.
-   **Methods moved here:**
    -   `handleNewFileRequest`
    -   `handleNewFolderRequest`
    -   `handleFileRenameRequest`
    -   `handleMoveFileRequest`
    -   `handleFileDeleteRequest`, `handleBatchFileDeleteRequest`
    -   `handleCopyFileRequest`, `handleCopyFileFromUri`, `handleAddFileFromBuffer`
    -   `handleOpenFileRequest`
    -   `handleRevealInExplorerRequest`
    -   `handleCopyPathRequest`

#### 3. `ContentExtractionService`
-   **Responsibility:** Handling the on-demand parsing and virtualization of special, non-text file formats.
-   **Methods moved here:**
    -   `handlePdfToTextRequest`, `getVirtualPdfContent`, `pdfTextCache`
    -   `handleExcelToTextRequest`, `getVirtualExcelContent`, `excelMarkdownCache`
    -   `handleWordToTextRequest`, `getVirtualWordContent`, `wordTextCache`
    -   `_sheetToMarkdown` (private helper)

#### 4. `HighlightingService`
-   **Responsibility:** All logic related to syntax highlighting.
-   **Methods moved here:**
    -   `initializeStarryNight`
    -   `handleSyntaxHighlightRequest`
    -   `starryNight` property

### 2.2. Integration

-   The main `services.ts` container was updated to instantiate all four new services.
-   The `on-message.ts` handlers were updated to call the correct methods on the new, more specific services.
-   The original `fs.service.ts` file has been deleted.

## 3. Benefits Achieved

-   **Reduced Complexity:** Each service is now significantly smaller and easier to understand.
-   **Improved Maintainability:** Bugs or feature requests will be easier to implement in the correct, isolated service.
-   **Clear Separation of Concerns:** The architecture now follows best practices.
-   **Lower Token Count:** Splitting the large file into four smaller ones makes each file more manageable.

<Original fs.service.ts>
Removed after completing refactor.
</Original fs.service.ts>