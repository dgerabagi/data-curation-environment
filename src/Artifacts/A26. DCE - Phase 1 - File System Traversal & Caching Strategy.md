# Artifact A26: DCE - Phase 1 - File System Traversal & Caching Strategy
# Date Created: C31
# Author: AI Model

- **Key/Value for A0:**
- **Description:** Documents the root cause of the folder visibility bug and outlines the new strategy of using recursive directory traversal instead of `findFiles` to build a complete and accurate file system map.
- **Tags:** bug fix, file system, traversal, refresh, cache, architecture

## 1. Overview & Goal

This document addresses a critical bug identified in Cycle 31 where newly created empty folders do not appear in the Data Curation file tree, even after a refresh. The goal is to document the root cause and define a new, more robust file system traversal strategy that guarantees an accurate representation of the workspace, including empty directories.

## 2. Root Cause Analysis (RCA)

-   **Symptom:** Creating a new, empty folder in the workspace does not result in that folder appearing in the DCE file tree. The file watcher correctly detects a change and triggers a full refresh, but the new folder is still missing from the rendered output.
-   **Root Cause:** The file discovery mechanism in `fs.service.ts` exclusively uses the `vscode.workspace.findFiles("**/*", ...)` API call. This API is optimized to return a flat list of **files** matching a glob pattern. It does **not** return directories, especially empty ones, as they are not considered "files".
-   **Impact:** When the file tree is reconstructed from this file-only list, any empty directories are completely invisible to the tree-building logic, making it impossible for the UI to ever display them. This is a major regression that breaks core functionality.

## 3. New Traversal Strategy

To resolve this, the reliance on `vscode.workspace.findFiles` for building the tree structure will be eliminated and replaced with a manual, recursive directory traversal.

### 3.1. Technical Implementation Plan

1.  **Primary API:** The new strategy will be centered around the `vscode.workspace.fs.readDirectory(uri)` API. This function returns an array of `[name, fileType]` tuples for all immediate children of a given directory URI. `fileType` can be `File`, `Directory`, `SymbolicLink`, or `Unknown`.

2.  **Recursive Function:** A new `private async _traverseDirectory(uri)` method will be implemented in `fs.service.ts`.
    *   **Input:** The `vscode.Uri` of the directory to scan.
    *   **Process:**
        1.  Call `vscode.workspace.fs.readDirectory(uri)` to get the contents.
        2.  Iterate through the `[name, fileType]` tuples.
        3.  Apply the exclusion logic (e.g., skip `node_modules`, `.git`).
        4.  For each entry, create a `FileNode` object.
        5.  If `fileType` is `vscode.FileType.Directory`, recursively call `_traverseDirectory` for that child and assign the result to the `children` property of its `FileNode`.
        6.  If `fileType` is `vscode.FileType.File`, calculate its stats (token count, etc.).
        7.  Return the array of `FileNode` children.

3.  **Integration (`handleWorkspaceFilesRequest`):**
    *   The main `handleWorkspaceFilesRequest` function will now initiate the process by calling `_traverseDirectory` with the workspace root URI.
    *   The result of this recursive traversal will be the complete, accurate file tree, which can then be cached and sent to the client.

## 4. Benefits of the New Approach

-   **Accuracy:** This method builds a true representation of the file system, including all directories, regardless of whether they are empty or not.
-   **Control:** It gives us full control over the traversal, allowing for more sophisticated filtering or caching logic in the future.
-   **Performance:** While potentially slower for extremely large workspaces than a highly optimized native `findFiles` call, it avoids the overhead of converting a flat path list into a tree structure, as the tree is built directly during the scan. Performance will be monitored.