# Artifact A70: DCE - Git-Integrated Testing Workflow Plan
# Date Created: C169
# Author: AI Model & Curator

- **Key/Value for A0:**
- **Description:** Outlines the plan for `Baseline (Commit)` and `Restore Baseline` buttons to streamline the testing of AI-generated code by leveraging Git.
- **Tags:** feature plan, workflow, git, testing, automation

## 1. Overview & Goal

A core part of the DCE workflow involves accepting an AI-generated response and testing it in the live workspace. If the response introduces bugs, the user must manually revert the changes. The goal of this feature is to automate this "test and revert" loop by deeply integrating with Git. This will provide a one-click method to create a baseline commit before testing and a one-click method to restore that baseline if the test fails.

## 2. User Stories

| ID | User Story | Acceptance Criteria |
|---|---|---|
| P2-GIT-01 | **Create Baseline** | As a developer, after accepting an AI response but before testing it, I want to click a "Baseline (Commit)" button to create a Git commit, so I have a safe restore point. | - A "Baseline (Commit)" button is available in the response acceptance header. <br> - Clicking it executes `git add .` and `git commit -m "DCE Baseline: Cycle [currentCycle] - [cycleTitle]"`. <br> - A success notification is shown. |
| P2-GIT-02 | **Restore Baseline** | As a developer, after testing an AI response and finding issues, I want to click a "Restore Baseline" button to discard all changes, so I can quickly test a different response. | - A "Restore Baseline" button is available. <br> - Clicking it executes `git restore .`. <br> - The restore operation must **exclude** DCE-specific state files (e.g., `.vscode/dce_history.json`) to prevent data loss. |

## 3. Feasibility Analysis

-   **"Insanely Powerful" Idea (Simulate TS Errors):**
    -   **Concept:** Programmatically run the TypeScript compiler on a virtual file system containing the proposed changes and display the resulting errors without modifying the user's workspace.
    -   **Feasibility:** This is a highly complex task. It would require integrating the TypeScript compiler API, creating an in-memory representation of the workspace file system, and managing dependencies. While theoretically possible, this is a very advanced feature that would require significant research and multiple development cycles.
    -   **Recommendation:** Defer as a long-term research goal.

-   **"Baseline/Restore" Idea:**
    -   **Concept:** Execute standard Git commands from the extension backend.
    -   **Feasibility:** This is highly feasible. The VS Code Git extension exposes an API that can be used to run commands, or a child process can be used to execute the `git` CLI directly. The main challenge is ensuring the `git restore` command excludes the necessary files.
    -   **Recommendation:** Proceed with planning and implementation.

## 4. Technical Implementation Plan

1.  **IPC Channels:**
    *   `ClientToServerChannel.RequestGitBaseline`: Payload `{ commitMessage: string }`.
    *   `ClientToServerChannel.RequestGitRestore`: No payload.

2.  **Backend (`file-operation.service.ts` or a new `git.service.ts`):**
    *   A new service, `GitService`, would be ideal to encapsulate this logic.
    *   **`handleGitBaselineRequest(commitMessage)`:**
        *   Get the workspace root path.
        *   Execute `git add .` using a child process (`exec`).
        *   Execute `git commit -m "${commitMessage}"` using a child process.
        *   Handle any errors from the Git commands and send a success/failure notification to the frontend.
    *   **`handleGitRestoreRequest()`:**
        *   Get the workspace root path.
        *   Find the path to `dce_history.json`.
        *   Execute `git restore -- . ':(exclude).vscode/dce_history.json'` using a child process. The `:(exclude)` pathspec is a powerful Git feature that allows for exclusions directly in the command. This is the key to preventing data loss.
        *   Handle errors and send notifications.

3.  **Frontend (`view.tsx`):**
    *   Add the "Baseline (Commit)" and "Restore Baseline" buttons to the UI.
    *   The `onClick` handler for "Baseline" will construct the commit message from the current cycle's data and send the `RequestGitBaseline` message.
    *   The `onClick` handler for "Restore" will send the `RequestGitRestore` message.