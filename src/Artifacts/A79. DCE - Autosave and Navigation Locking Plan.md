# Artifact A79: DCE - Autosave and Navigation Locking Plan
# Date Created: C7
# Author: AI Model & Curator

- **Key/Value for A0:**
- **Description:** Outlines the plan to fix the cycle data loss bug by implementing a UI-driven autosave status indicator and locking navigation controls while there are unsaved changes.
- **Tags:** bug fix, data integrity, race condition, autosave, ui, ux

## 1. Overview & Goal

A critical data loss bug has been observed where navigating between cycles in the Parallel Co-Pilot Panel can cause data from one cycle to overwrite another. This is caused by a race condition between the debounced auto-save of the departing cycle and the loading of the new cycle's state.

The goal is to implement a definitive fix by creating a clear and robust user experience that prevents this race condition from occurring. This will be achieved by making the user aware of the save state and preventing navigation until all changes are safely persisted.

## 2. User Stories

| ID | User Story | Acceptance Criteria |
|---|---|---|
| BUG-01 | **Prevent Data Loss** | As a user, when I quickly navigate between cycles, I want to be confident that my data from the previous cycle is saved before the new cycle loads, so no data is ever lost or corrupted. | - Navigating away from a cycle with unsaved changes is prevented until the save operation is complete. |
| UX-01 | **See Save Status** | As a user, I want to see a clear visual indicator of the current save status (e.g., "Unsaved changes," "Saving...," "Saved"), so I understand the state of my work. | - An icon or text is displayed near the cycle navigator. <br> - It updates in real-time to reflect the save status. |
| UX-02 | **Locked Navigation** | As a user, when I have unsaved changes, I want the cycle navigation buttons to be temporarily disabled, so I have a clear visual cue that I cannot change cycles until my work is saved. | - The "Next" (`>`), "Previous" (`<`), and "New" (`+`) cycle buttons are disabled when the save status is "unsaved" or "saving." <br> - The buttons become enabled once the status returns to "saved." |

## 3. Technical Implementation Plan

1.  **New State Management (`view.tsx`):**
    *   Introduce a new state variable to track the save status: `const [saveStatus, setSaveStatus] = useState<'saved' | 'saving' | 'unsaved'>('saved');`
    *   All `onChange` handlers for data that is persisted per-cycle (title, contexts, response tabs) will be updated to immediately call `setSaveStatus('unsaved')`.

2.  **Refactor Autosave Logic:**
    *   **IPC:** A new `ServerToClientChannel.NotifySaveComplete` channel will be created. The payload will be `{ cycleId: number }`.
    *   **Backend (`history.service.ts`):** The `saveCycleData` method will, after successfully writing the file, send the `NotifySaveComplete` message back to the client with the ID of the cycle that was just saved.
    *   **Frontend (`view.tsx`):**
        *   The existing debounced `saveCurrentCycleState` function will be modified.
        *   When triggered, it will first call `setSaveStatus('saving')`.
        *   It will then send the `SaveCycleData` message to the backend as it does now.
        *   A new message handler will be added to listen for `NotifySaveComplete`. When it receives confirmation for the *currently viewed cycle*, it will call `setSaveStatus('saved')`.

3.  **Update UI Components:**
    *   **`CycleNavigator.tsx`:**
        *   This component will receive `saveStatus` as a prop.
        *   The `disabled` attribute of the `<`, `>`, and `+` buttons will be set to `saveStatus !== 'saved'`.
    *   **`view.tsx` & `view.scss`:**
        *   A new component or set of icons will be rendered near the cycle navigator to display the current `saveStatus`. For example:
            *   `'unsaved'`: A yellow dot with the tooltip "Unsaved changes".
            *   `'saving'`: A spinning icon with the tooltip "Saving...".
            *   `'saved'`: A green checkmark with the tooltip "Saved".

4.  **Update Navigation Logic (`view.tsx`):**
    *   The `handleCycleChange` function will be simplified. Since the navigation buttons are disabled when there are unsaved changes, it no longer needs to trigger a save itself. Its only job is to request the data for the new cycle.