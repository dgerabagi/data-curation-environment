# Artifact A56: DCE - Phase 2 - Advanced Diff Viewer Plan
# Date Created: C120
# Author: AI Model & Curator
# Updated on: C125 (Add Exit button, navigation, and detail panes)

- **Key/Value for A0:**
- **Description:** Details the plan to enhance the integrated diff viewer with a side-by-side layout, line alignment, and WinMerge-like navigation controls to jump between differences.
- **Tags:** feature plan, phase 2, ui, ux, diff, navigation, side-by-side

## 1. Overview & Goal

The current diff view is functional but lacks key usability features found in mature diff tools like WinMerge. The goal of this plan is to enhance the diff viewer to provide a much clearer and more efficient user experience. This involves several key enhancements:
1.  **Side-by-Side Layout:** Displaying the original and modified files in two parallel panes.
2.  **Line Alignment:** Inserting placeholder lines to ensure that common (unchanged) code blocks remain horizontally aligned.
3.  **Navigation Controls:** Adding buttons to allow the user to quickly jump between blocks of differences.
4.  **Difference Detail Panes:** Adding two panes at the bottom of the view to show the specific lines of the currently selected difference.
5.  **Exit Mechanism:** Providing a clear button to exit the diff view and return to the summary view.

## 2. User Stories

| ID | User Story | Acceptance Criteria |
|---|---|---|
| P2-DIFF-01 | **Colored Side-by-Side Diffs** | As a developer, I want to see a side-by-side view of the original and modified code with a colored background for changed lines, so I can immediately identify changes at a glance. | - The diff view is split into two vertical panes: "Original" on the left, "Modified" on the right. <br> - Lines that exist in the new version but not the old have a distinct background color (e.g., light green) in the right pane. <br> - Lines that exist in the old version but not the new have a different background color (e.g., light red) in the left pane. <br> - Unchanged lines have the standard editor background color in both panes. |
| P2-DIFF-02 | **Aligned Content** | As a developer, when a block of lines is added or removed, I want the other pane to show empty space, so that the lines of code below the change remain horizontally aligned. | - When lines are added in the right pane, an equal number of empty placeholder rows are rendered in the left pane. <br> - When lines are removed from the left pane, an equal number of empty placeholder rows are rendered in the right pane. <br> - This ensures that a common line `X` appears at the same vertical position in both panes, regardless of changes above it. |
| P2-DIFF-03 | **Navigate Between Diffs** | As a developer reviewing a large file, I want "Next Difference" and "Previous Difference" buttons, so I can quickly jump between changed blocks without manually scrolling. | - "Next Difference" (`↓`) and "Previous Difference" (`↑`) buttons are added to the diff viewer's header. <br> - Clicking "Next Difference" scrolls the view to the start of the next block of added or removed lines and highlights it. <br> - Clicking "Previous Difference" scrolls to the previous block. <br> - The buttons are disabled when at the start or end of the diff list. |
| P2-DIFF-04 | **Exit Diff View** | As a developer in the diff view, I want a clear way to return to the summary and file list view, so I can select a different file or review the AI's plan. | - A "Back to Summary" or similar button is present in the header when in diff mode. <br> - Clicking it returns the UI to the two-pane summary/code viewer layout. |
| P2-DIFF-05 | **View Diff Details** | As a developer navigating between differences, I want to see the specific lines of the currently selected difference in a separate, focused view, so I can analyze the change without the surrounding code. | - Two new panes are added at the bottom of the diff viewer. <br> - When a difference is selected (via navigation buttons or clicking), the left pane shows the original lines and the right pane shows the modified lines from that specific change block. |

## 3. Technical Implementation Plan

### 3.1. Side-by-Side Diff Logic (`DiffViewer.tsx`)

-   **Processing:** The component will receive the `original` and `modified` strings. It will use the `diffArrays` function from the `diff` library on the line-split strings for a more granular, line-by-line comparison.
-   **Data Structure:** It will process the resulting `Change[]` array into a unified data structure that represents every row in the side-by-side view, correctly interleaving `added`, `removed`, and `common` lines with `placeholder` lines to ensure perfect horizontal alignment.
-   **State Management:**
    *   `const [diffBlocks, setDiffBlocks] = useState<number[]>([]);` // Stores the starting line index of each change.
    *   `const [selectedDiffIndex, setSelectedDiffIndex] = useState<number | null>(null);` // Tracks the currently selected difference.
-   **Navigation Logic:**
    *   The component will identify all changed blocks and store their indices in `diffBlocks`.
    *   `goToNextDiff` and `goToPrevDiff` functions will update `selectedDiffIndex`.
    *   A `useEffect` will trigger on `selectedDiffIndex` change, find the corresponding DOM element, and use `scrollIntoView()`.
-   **Rendering:** The component will render two main `div`s (`.diff-pane`). It will map over the unified data structure, rendering the appropriate content for each side.

### 3.2. Detail Panes & UI Controls (`DiffViewer.tsx`, `view.tsx`)

-   **Detail Panes (`DiffViewer.tsx`):**
    *   Two new `div`s will be added at the bottom, inside a `.diff-detail-container`.
    *   Their content will be derived from the main data structure, filtered to show only the lines corresponding to the `selectedDiffIndex`.
-   **UI Controls (`view.tsx`):**
    *   The PCPP header will conditionally render the navigation and exit buttons when `isDiffMode` is true.
    *   The `onClick` handlers for these buttons will call the appropriate functions passed down from `DiffViewer` or modify the `isDiffMode` state.

### 3.3. Styling (`view.scss`)

-   New CSS classes will be added for:
    *   The bottom detail panes (`.diff-detail-container`, `.diff-detail-pane`).
    *   A highlight for the selected difference in the main view (`.line.selected-diff`).
    *   Styling for the navigation buttons in the header.
    *   Ensuring `white-space: pre;` is applied to prevent word wrapping.
    *   Fixing vertical alignment of line numbers and text.