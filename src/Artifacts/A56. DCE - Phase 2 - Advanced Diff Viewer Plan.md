# Artifact A56: DCE - Phase 2 - Advanced Diff Viewer Plan
# Date Created: C120
# Author: AI Model & Curator
# Updated on: C132 (Add keyboard navigation and clarify scrollbar behavior)

- **Key/Value for A0:**
- **Description:** Details the plan to enhance the integrated diff viewer with a side-by-side layout, scroll-locking, keyboard navigation, and a location pane.
- **Tags:** feature plan, phase 2, ui, ux, diff, navigation, side-by-side, scroll-lock, keyboard

## 1. Overview & Goal

The current diff view is functional but lacks key usability features found in mature diff tools like WinMerge. The goal of this plan is to enhance the diff viewer to provide a much clearer and more efficient user experience. This involves several key enhancements:
1.  **Side-by-Side Main Layout:** Displaying the original and modified files in two parallel, vertical panes.
2.  **Top-and-Bottom Detail Layout:** Displaying the character-level diff in two panes stacked vertically at the bottom.
3.  **Scroll-Locking:** Synchronizing the scroll position of the two main panes and the two detail panes, with all four panes having visible scrollbars.
4.  **Keyboard Navigation:** Allowing users to navigate between differences and accept changes using only the keyboard.
5.  **Location Pane (Future):** A visual overview of all changes in the file.

## 2. User Stories

| ID | User Story | Acceptance Criteria |
|---|---|---|
| P2-DIFF-01 | **Side-by-Side Diffs** | As a developer, I want to see a side-by-side view of the original and modified code with a colored background for changed lines, so I can immediately identify changes at a glance. | - The main diff view is split into two vertical panes: "Original Workspace File" on the right, "AI Response" on the left. <br> - Lines are colored appropriately for additions and removals. |
| P2-DIFF-02 | **Scroll-Locking** | As a developer, when I scroll one of the main diff panes vertically, I want the other main pane to scroll with it, so I can keep the corresponding code aligned. | - All four diff panes have their own scrollbars. <br> - The two main diff panes are scroll-locked vertically. <br> - The two bottom detail panes are scroll-locked horizontally. |
| P2-DIFF-03 | **Navigate Between Diffs** | As a developer reviewing a large file, I want "Next Difference" and "Previous Difference" buttons, so I can quickly jump between changed blocks. | - "Next Difference" (`↓`) and "Previous Difference" (`↑`) buttons are located in a stable toolbar. <br> - Clicking scrolls the view to the start of the next/previous block of changes and highlights it. |
| P2-DIFF-04 | **Keyboard Navigation & Acceptance** | As a developer, I want to use the up/down arrow keys to navigate between differences and the right arrow key to accept the change from the response, so I can review and merge code without using the mouse. | - Pressing `ArrowDown` selects the next difference block. <br> - Pressing `ArrowUp` selects the previous difference block. <br> - Pressing `ArrowRight` accepts the change from the left (AI) pane, visually updating the right (original) pane's content *in memory*. |
| P2-DIFF-05 | **Location Pane (Future)** | As a developer, I want to see a miniature, vertical map of all the changes in the file, so I can understand the overall scope of the diff and quickly jump to any section. | - A new "Location Pane" is displayed above the main diff view. <br> - It shows a compressed visual representation of the entire file, with colored blocks indicating added, removed, and changed lines. <br> - Clicking on a block in this pane scrolls the main diff view to that location. |
| P2-DIFF-06 | **Line Numbers in Detail Pane (Future)** | As a developer, I want to see line numbers in the bottom character-level diff panes, so I have context for where the detailed change is occurring. | - The bottom panes display the relevant line numbers next to the content. |

## 3. Technical Implementation Plan

### 3.1. Layout & Scroll-Locking (`DiffViewer.tsx`, `view.scss`)
-   **Layout:** The main container will use `flex-direction: row` (side-by-side) and the detail container will use `flex-direction: column` (top/bottom).
-   **Scroll-Locking:** `useRef` will be used for all four scrollable panes. `onScroll` event handlers will synchronize the `scrollTop` or `scrollLeft` properties of their counterparts. CSS will no longer hide any scrollbars.

### 3.2. Keyboard Navigation (`DiffViewer.tsx`)
-   **Event Listener:** A `useEffect` hook will add a `keydown` event listener to the component's main wrapper `div` (which must have a `tabIndex` to be focusable).
-   **State Management:**
    *   The existing `selectedDiffIndex` state will be used. The `ArrowUp` and `ArrowDown` handlers will simply increment or decrement this state.
    *   A new state will be added to manage the content of the original file: `const [originalLines, setOriginalLines] = useState(original.content.split('\n'));`.
    *   The diff generation logic in the `useMemo` hook will be updated to use `originalLines` as its source instead of the static `original.content` prop.
-   **Accept Logic (`ArrowRight`):**
    1.  Get the current difference block from `pairedLines` using `selectedDiffIndex`.
    2.  Identify the line numbers and content for this block from both the `left` (AI) and `right` (original) sides.
    3.  Create a new array based on `originalLines`.
    4.  Splice the new lines from the AI response into the correct position in the new array, replacing the old lines.
    5.  Call `setOriginalLines` with this new array. This will trigger a re-render, visually showing the change as "accepted".