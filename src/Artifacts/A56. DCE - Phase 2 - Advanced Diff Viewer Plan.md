# Artifact A56: DCE - Phase 2 - Advanced Diff Viewer Plan
# Date Created: C120
# Author: AI Model & Curator
# Updated on: C129 (Switch to vertical layout, fixed panes, and bottom controls)

- **Key/Value for A0:**
- **Description:** Details the plan to enhance the integrated diff viewer with a vertical layout, fixed-size panes, and WinMerge-like navigation controls to jump between differences.
- **Tags:** feature plan, phase 2, ui, ux, diff, navigation, vertical-layout

## 1. Overview & Goal

The current diff view is functional but lacks key usability features found in mature diff tools like WinMerge. The goal of this plan is to enhance the diff viewer to provide a much clearer and more efficient user experience. This involves several key enhancements:
1.  **Vertical Layout:** Displaying the original and modified files in two panes, one on top of the other, to better facilitate line-by-line comparison.
2.  **Fixed-Size Panes:** The two panes will have a fixed height and will be internally scrollable, preventing the overall UI from shifting when navigating between diffs of different lengths.
3.  **Relocated Navigation Controls:** The "Next/Previous Difference" buttons will be moved to a stable location below the diff panes.
4.  **Difference Detail Panes:** Adding two panes at the bottom of the view to show the specific lines of the currently selected difference, with character-level highlighting.
5.  **Exit Mechanism:** Providing a clear button to exit the diff view and return to the summary view.

## 2. User Stories

| ID | User Story | Acceptance Criteria |
|---|---|---|
| P2-DIFF-01 | **Vertical Colored Diffs** | As a developer, I want to see a top-and-bottom view of the original and modified code with a colored background for changed lines, so I can immediately identify changes at a glance. | - The diff view is split into two horizontal panes: "Original" on top, "Modified" on the bottom. <br> - Lines that exist in the new version but not the old have a distinct background color (e.g., light green) in the bottom pane. <br> - Lines that exist in the old version but not the new have a different background color (e.g., light red) in the top pane. <br> - Unchanged lines have the standard editor background color in both panes. |
| P2-DIFF-02 | **Fixed-Size Panes** | As a developer, I want the diff panes to remain a constant size when I navigate between differences, so the UI controls do not move around. | - Each diff pane has a fixed height (e.g., `flex-basis: 50%` or a pixel value). <br> - If the code content exceeds the pane's height, a vertical scrollbar appears within that pane. |
| P2-DIFF-03 | **Navigate Between Diffs** | As a developer reviewing a large file, I want "Next Difference" and "Previous Difference" buttons located below the diff panes, so I can quickly jump between changed blocks without the buttons moving. | - "Next Difference" (`↓`) and "Previous Difference" (`↑`) buttons are located in a stable toolbar below the main diff panes. <br> - Clicking "Next Difference" scrolls the view to the start of the next block of added or removed lines and highlights it as a single block. |
| P2-DIFF-04 | **Exit Diff View** | As a developer in the diff view, I want a clear way to return to the summary and file list view, so I can select a different file or review the AI's plan. | - A "Back to Code" or similar button is present in the UI. <br> - Clicking it returns the UI to the two-pane summary/code viewer layout. |
| P2-DIFF-05 | **View Diff Details with Phantom Spaces**| As a developer, I want the detail pane to show a character-level diff of the selected change, using phantom spaces to align the unchanged parts of the text. | - The detail panes at the bottom show the character-level differences for the selected line(s). <br> - Unchanged text is aligned vertically between the two panes through the insertion of non-breaking spaces. |

## 3. Technical Implementation Plan

### 3.1. Vertical Diff Logic (`DiffViewer.tsx`)

-   **Layout:** The main container for the two panes will have `flex-direction: column`.
-   **Data Structure:** The existing `PairedLine` data structure is still valid for generating the content of each pane.
-   **Block Highlighting:**
    *   A new function will identify the start and end indices of a contiguous diff block.
    *   The render logic will be refactored. Instead of applying a class to each `.line`, it will map over the `pairedLines` array and group consecutive `isDiff: true` lines. Each group will be wrapped in a single `<div class="diff-block selected-diff">` to create the block highlight effect.

### 3.2. Detail Panes & UI Controls (`DiffViewer.tsx`, `view.tsx`)

-   **Relocated Controls (`DiffViewer.tsx`):** The navigation buttons will be moved out of the main PCPP header and into a new `.diff-detail-header` div within the `DiffViewer` component itself, positioning them between the main diff view and the bottom detail panes.
-   **Character-Level Diff with Phantom Spaces (`DiffViewer.tsx`):**
    *   A new `renderCharDiff` function will be implemented.
    *   It will take the original and modified text of a diff block.
    *   It will use `diffChars` from the `diff` library.
    *   It will iterate through the changes. For `added` parts, it will render the text in the "modified" pane and an equivalent number of non-breaking spaces (`&nbsp;`) in the "original" pane. For `removed` parts, it will do the opposite. `common` parts are rendered in both. This will achieve the desired alignment.

### 3.3. Styling (`view.scss`)

-   Update the `.diff-viewer-container` to use `flex-direction: column`.
-   Add `flex-basis`, `min-height: 0`, and `overflow-y: auto` to the `.diff-pane` class to enforce fixed, scrollable panes.
-   Add styling for the new `.diff-block` and `.selected-diff` classes to create the block highlight effect.
-   Add styling for the new `.diff-detail-header` and the navigation controls within it.
-   Add styles for `.phantom-space` to render the alignment characters correctly (e.g., with a subtle background).