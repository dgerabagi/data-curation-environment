# Artifact A98: DCE - Harmony JSON Output Schema Plan
# Date Created: C50
# Author: AI Model & Curator

- **Key/Value for A0:**
- **Description:** A plan to migrate the vLLM interaction schema from XML-based parsing to a structured JSON object output, leveraging the `response_format` parameter in OpenAI-compatible APIs.
- **Tags:** plan, architecture, interaction schema, parsing, llm, vllm, harmony, json

## 1. Vision & Goal

The current method of parsing AI responses relies on a set of regular expressions to extract content from within custom XML tags (`<summary>`, `<file>`, etc.). While functional, this approach is brittle and can fail if the model produces even slightly malformed output.

Modern OpenAI-compatible APIs, including the one provided by vLLM, support a `response_format` parameter that can instruct the model to return its output as a guaranteed-valid JSON object. The goal of this plan is to leverage this feature to create a more robust, reliable, and maintainable parsing pipeline. We will define a clear JSON schema and update our extension to request and parse this structured format, moving away from fragile regex-based text processing.

## 2. The Proposed JSON Schema

Based on the example provided in the ephemeral context of Cycle 50, the target JSON schema for an AI response will be as follows:

```typescript
interface HarmonyFile {
  path: string;
  content: string;
}

interface CourseOfActionStep {
  step: number;
  description: string;
}

interface HarmonyJsonResponse {
  summary: string;
  course_of_action: CourseOfActionStep[];
  files_updated?: string[]; // Optional, can be derived from `files`
  curator_activity?: string; // Optional
  files: HarmonyFile[];
}
```

### Example JSON Output:
```json
{
  "summary": "I have analyzed the request and will update the main application component and its corresponding service.",
  "course_of_action": [
    {
      "step": 1,
      "description": "Update `src/App.tsx`: Add a new state variable and a button to trigger the new functionality."
    },
    {
      "step": 2,
      "description": "Update `src/services/api.ts`: Create a new function to fetch the required data from the backend."
    }
  ],
  "curator_activity": "Please ensure the backend API endpoint `GET /api/newdata` is running and accessible.",
  "files": [
    {
      "path": "src/App.tsx",
      "content": "// Full content of the updated App.tsx file..."
    },
    {
      "path": "src/services/api.ts",
      "content": "// Full content of the updated api.ts file..."
    }
  ]
}
```

## 3. Technical Implementation Plan

1.  **Backend (`llm.service.ts`):**
    *   The `generateBatch` method will be updated.
    *   When the `connectionMode` is set to `'demo'`, it will add `response_format: { "type": "json_object" }` to the JSON body of the `fetch` request sent to the vLLM proxy. This instructs the model to generate a JSON response.

2.  **Frontend (`response-parser.ts`):**
    *   The `parseResponse` function will be refactored to be "bilingual."
    *   It will first attempt to parse the `rawText` as JSON using a `try...catch` block.
    *   **If `JSON.parse` succeeds:**
        *   It will validate that the parsed object contains the required keys (`summary`, `course_of_action`, `files`).
        *   It will map the data from the JSON object to the `ParsedResponse` type.
            *   The `course_of_action` array will be formatted into a numbered markdown list.
            *   The `files` array will be directly mapped to the `ParsedFile` array.
    *   **If `JSON.parse` fails:**
        *   It will fall back to the existing regex-based parsing logic. This ensures backward compatibility with the manual copy/paste mode and any models that do not support JSON output mode.

3.  **Interaction Schema (`A52.3`):**
    *   The `A52.3 DCE - Harmony Interaction Schema Source.md` will be updated.
    *   It will now instruct the AI to produce its output in the specified JSON format, providing the schema definition as an example. The instructions for using XML tags will be preserved as a fallback for the model.

This migration to a structured JSON format will significantly improve the reliability of the extension's core parsing logic.