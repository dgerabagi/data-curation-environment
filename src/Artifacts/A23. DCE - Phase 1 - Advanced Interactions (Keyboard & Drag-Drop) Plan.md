# Artifact A23: DCE - Phase 1 - Advanced Interactions (Keyboard & Drag-Drop) Plan
# Date Created: C29
# Author: AI Model
# Updated on: C57 (Finalized robust event handling strategy for external drag-drop)

- **Key/Value for A0:**
- **Description:** Details the requirements for implementing full keyboard navigation and drag-and-drop file/folder operations within the main file tree view.
- **Tags:** feature plan, keyboard navigation, drag and drop, file operations, accessibility, ux, phase 1

## 1. Overview & Goal

To achieve true feature parity with the native VS Code Explorer and cater to power users, the Data Curation Environment must support advanced interactions. This plan outlines the requirements for two major features: full keyboard navigation for accessibility and speed, and drag-and-drop functionality for intuitive file system manipulation.

## 2. User Stories

| ID | User Story | Acceptance Criteria |
|---|---|---|
| AI-01 | **Keyboard Navigation** | As a power user, I want to navigate the file tree using only my keyboard, so I can find, select, and manage files without taking my hands off the keyboard. | - Arrow Up/Down keys move the focus between visible nodes. <br> - Arrow Right on a collapsed folder expands it. <br> - Arrow Left on an open folder collapses it. <br> - `Enter` key opens the focused file or toggles expansion. <br> - `Spacebar` toggles the checkbox of the focused node. |
| AI-02 | **Internal Drag-and-Drop** | As a user, I want to be able to drag a file or folder and drop it into another folder within the DCE view to move it, so I can reorganize my project intuitively. | - Clicking and dragging a file or folder initiates a drag operation. <br> - Dragging over a folder highlights it as a potential drop target. <br> - Dropping a file/folder onto another folder moves the dragged item. |
| AI-03 | **External Drag-and-Drop** | As a user, I want to drag a file (e.g., a PDF) from my computer's file explorer and drop it into a folder in the DCE view to add it to my project, so I can quickly incorporate new assets. | - Dragging a file from the OS and dropping it onto a folder in the DCE view copies that file into the target folder in the workspace. <br> - The file tree automatically refreshes to show the newly added file. |
| AI-06 | **Hover to Expand Folder** | As a user dragging a file, when I hover over a collapsed folder for a moment, I want it to automatically expand, so I can drop the file into a nested subdirectory without having to cancel the drag operation. | - During a drag operation, hovering over a collapsed folder for ~500ms triggers its expansion. <br> - Moving the mouse away from the folder before the timer completes cancels the expansion. |

## 3. Technical Implementation Plan

### Keyboard Navigation & Internal Drag-Drop (Completed)
These features are stable and complete.

### External Drag and Drop (Implementation C57)
This requires a multi-layered event handling strategy to provide clear visual feedback and robust functionality.

1.  **Critical: `event.preventDefault()` in `onDragOver`:** The most common failure point for HTML drag-and-drop is neglecting to call `event.preventDefault()` in the `onDragOver` handler. This call is **mandatory** to signal to the browser that the element is a valid drop target. Without it, the `onDrop` event will **never fire**. This must be implemented on all potential drop zones.

2.  **Event Propagation (`event.stopPropagation()`):** To prevent conflicting drop handlers (e.g., a node and its parent container), `stopPropagation()` must be called in the node-level handlers to stop the event from bubbling up to the main view container.

3.  **Main Container Handlers (`view.tsx`):**
    *   The main container will have `onDragEnter`, `onDragOver`, `onDragLeave`, and `onDrop`.
    *   `onDragEnter`/`onDragLeave` will toggle a `.drag-over` class for visual feedback (e.g., a dashed border around the whole view).
    *   `onDragOver` will call `event.preventDefault()` and log its execution.
    *   `onDrop` on the container acts as a fallback for drops in empty space, targeting the workspace root directory. It will prevent default behavior and process the files.

4.  **Individual Node Handlers & Hover-to-Expand (`TreeView.tsx`):**
    *   The generic `TreeView` component will manage drag events for each `<li>` node.
    *   **State:** It will manage `dropTarget` (for highlighting) and a `useRef` for a `setTimeout` timer.
    *   `onDragEnter` (on `<li>`): It will call `event.stopPropagation()`. If the node is a collapsed directory, it will start a 500ms timer. If the timer completes, it will call the function to expand the node.
    *   `onDragLeave` (on `<li>`): It will call `event.stopPropagation()` and, critically, **clear the expansion timer**.
    *   `onDragOver` (on `<li>`): It will call `event.preventDefault()` and `event.stopPropagation()`.
    *   `onDrop` (on `<li>`): It will call `event.stopPropagation()`, clear the timer, and delegate the file processing logic to the parent `FileTree` component via a prop function (`onNodeDrop`).

5.  **File Processing Logic (`FileTree.tsx`):**
    *   The `FileTree` component will define the `handleNodeDrop(event, node)` function.
    *   This function determines the final target directory (the node's path if it's a directory, or its parent's path if it's a file).
    *   It will iterate through `event.dataTransfer.files`, read each using the `FileReader` API to get an `ArrayBuffer`, convert it to a `Uint8Array`, and send the file's name and buffer to the backend via the `RequestAddFileFromBuffer` IPC message.
    *   **Logging:** All event handlers (`onDragEnter`, `onDragOver`, `onDragLeave`, `onDrop`) in all components will have detailed `logger.log()` statements to trace the event flow and diagnose any failures.