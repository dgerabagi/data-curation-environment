# Artifact A23: DCE - Phase 1 - Advanced Interactions (Keyboard & Drag-Drop) Plan
# Date Created: C29
# Author: AI Model
# Updated on: C36 (Add Ctrl+A requirement and focus management notes)

- **Key/Value for A0:**
- **Description:** Details the requirements for implementing full keyboard navigation and drag-and-drop file/folder operations within the main file tree view.
- **Tags:** feature plan, keyboard navigation, drag and drop, file operations, accessibility, ux, phase 1

## 1. Overview & Goal

To achieve true feature parity with the native VS Code Explorer and cater to power users, the Data Curation Environment must support advanced interactions. This plan outlines the requirements for two major features: full keyboard navigation for accessibility and speed, and drag-and-drop functionality for intuitive file system manipulation.

## 2. User Stories

| ID | User Story | Acceptance Criteria |
|---|---|---|
| AI-01 | **Keyboard Navigation** | As a power user, I want to navigate the file tree using only my keyboard, so I can find, select, and manage files without taking my hands off the keyboard. | - Arrow Up/Down keys move the focus between visible nodes. <br> - Arrow Right on a collapsed folder expands it. <br> - Arrow Right on an open folder or file moves focus to the first child. <br> - Arrow Left on an open folder collapses it. <br> - Arrow Left on a child node moves focus to its parent. <br> - `Enter` key opens the focused file or toggles expansion for a focused folder. <br> - `Spacebar` toggles the checkbox of the focused node. |
| AI-02 | **Drag-and-Drop File Operations** | As a user, I want to be able to drag a file or folder and drop it into another folder to move it, so I can reorganize my project intuitively. | - Clicking and dragging a file or folder in the tree initiates a drag operation. <br> - Dragging over a folder highlights it as a potential drop target. <br> - Dropping a file/folder onto another folder moves the dragged item into the target folder. <br> - The backend file system is updated, and the tree view refreshes to reflect the new structure. |
| AI-03 | **Select All in Selected List** | As a user, after curating a list, I want to click in the "Selected Items" panel and press `Ctrl+A` to select all files in that list, so I can quickly perform a batch action like "Remove selected". | - Clicking within the "Selected Items" panel gives it focus. <br> - Pressing `Ctrl+A` (or `Cmd+A`) selects all items currently rendered in the list. <br> - This action does not affect the main editor. <br> - The "Remove selected" button's count updates to reflect the total number of items in the list. |

## 3. Technical Implementation Plan

### Keyboard Navigation (In Progress - C36)

1.  **Focus Management (Frontend):**
    *   **Root Cause:** The webview panel loses keyboard focus to the main editor pane. The solution is to programmatically re-focus the correct container after user interactions.
    *   A state variable, `focusedNodePath: string | null`, tracks the currently focused node in the main tree.
    *   The `TreeView.tsx` component's main wrapper `div` has a `tabIndex={0}` attribute to make it programmatically focusable. A `ref` is attached to this `div`.
    *   **Crucial Fix:** In all mouse-based interaction handlers (`handleNodeClick`, etc.), a call to `treeViewRef.current.focus()` must be made to ensure keyboard events are captured by the `onKeyDown` handler.
2.  **Event Handling (`TreeView.tsx`):**
    *   The `onKeyDown` handler contains a `switch` statement for `event.key`. It calls `event.preventDefault()` for handled keys to stop them from propagating to the editor.
    *   A memoized, flattened list of all *visible* nodes is used to calculate the next/previous node for Up/Down arrow navigation.
    *   The handler updates `focusedNodePath`, `expandedNodes` (for Left/Right arrows), or triggers the checkbox toggle function (for Spacebar).
    *   The component applies a `.focused` CSS class to the node wrapper whose path matches `focusedNodePath`.

### Drag and Drop (Completed - C34)

The native `vscode.TreeDragAndDropController` is designed for extensions using a `TreeDataProvider`. Since our UI is a custom React webview, a different approach using the HTML5 Drag and Drop API was successfully implemented.

### Select All (`Ctrl+A`) in Selected Items (In Progress - C36)

1.  **Focus Management (`SelectedFilesView.tsx`):**
    *   The `ul.selected-files-list` element will be made focusable by adding `tabIndex={0}` and attaching a `ref` to it.
    *   An `onClick` handler on the component's container will call `listRef.current.focus()` to ensure the list captures focus.
2.  **Event Handling (`SelectedFilesView.tsx`):**
    *   An `onKeyDown` handler will be added to the `ul` element.
    *   It will check for `event.ctrlKey && event.key === 'a'` (and the Mac equivalent).
    *   On match, it will call `event.preventDefault()`.
    *   It will then create a new `Set` containing the `absolutePath` of all items in the `sortedFiles` array and call the `setSelection` state updater.
3.  **Styling (`view.scss`):**
    *   A `.selected-files-list:focus` style will be added to provide a visual outline, using `var(--vscode-focusBorder)`.