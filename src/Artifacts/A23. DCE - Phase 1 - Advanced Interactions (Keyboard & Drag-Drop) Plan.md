# Artifact A23: DCE - Phase 1 - Advanced Interactions (Keyboard & Drag-Drop) Plan
# Date Created: C29
# Author: AI Model
# Updated on: C35 (Mark Keyboard Navigation as In Progress)

- **Key/Value for A0:**
- **Description:** Details the requirements for implementing full keyboard navigation and drag-and-drop file/folder operations within the main file tree view.
- **Tags:** feature plan, keyboard navigation, drag and drop, file operations, accessibility, ux, phase 1

## 1. Overview & Goal

To achieve true feature parity with the native VS Code Explorer and cater to power users, the Data Curation Environment must support advanced interactions. This plan outlines the requirements for two major features: full keyboard navigation for accessibility and speed, and drag-and-drop functionality for intuitive file system manipulation.

## 2. User Stories

| ID | User Story | Acceptance Criteria |
|---|---|---|
| AI-01 | **Keyboard Navigation** | As a power user, I want to navigate the file tree using only my keyboard, so I can find, select, and manage files without taking my hands off the keyboard. | - Arrow Up/Down keys move the focus between visible nodes. <br> - Arrow Right on a collapsed folder expands it. <br> - Arrow Right on an open folder or file moves focus to the first child. <br> - Arrow Left on an open folder collapses it. <br> - Arrow Left on a child node moves focus to its parent. <br> - `Enter` key opens the focused file or toggles expansion for a focused folder. <br> - `Spacebar` toggles the checkbox of the focused node. |
| AI-02 | **Drag-and-Drop File Operations** | As a user, I want to be able to drag a file or folder and drop it into another folder to move it, so I can reorganize my project intuitively. | - Clicking and dragging a file or folder in the tree initiates a drag operation. <br> - Dragging over a folder highlights it as a potential drop target. <br> - Dropping a file/folder onto another folder moves the dragged item into the target folder. <br> - A confirmation dialog may be shown for destructive moves. <br> - The backend file system is updated, and the tree view refreshes to reflect the new structure. |

## 3. Technical Implementation Plan

### Keyboard Navigation (In Progress - C35)

1.  **Focus Management (Frontend):**
    *   A new state variable, `focusedNodePath: string | null`, will be added to `view.tsx` to track the currently focused node.
    *   The `TreeView.tsx` component's main wrapper `div` will get a `tabIndex={0}` attribute to make it programmatically focusable.
    *   An `onKeyDown` event handler will be attached to this wrapper.
2.  **Event Handling (`TreeView.tsx`):**
    *   The `onKeyDown` handler will contain a `switch` statement for `event.key`. It will call `event.preventDefault()` for handled keys to stop them from propagating to the editor.
    *   A memoized, flattened list of all *visible* nodes will be created and maintained. This is crucial for calculating the next/previous node for Up/Down arrow navigation.
    *   The handler will update `focusedNodePath`, `expandedNodes` (for Left/Right arrows), or trigger the checkbox toggle function (for Spacebar).
    *   The component will apply a `.focused` CSS class to the node wrapper whose path matches `focusedNodePath`.
3.  **Styling (`view.scss`):**
    *   A new `.treenode-item-wrapper.focused` class will be added to provide a visual outline, using `var(--vscode-focusBorder)`.

### Drag and Drop (Completed - C34)

The native `vscode.TreeDragAndDropController` is designed for extensions using a `TreeDataProvider`. Since our UI is a custom React webview, a different approach was required and has been implemented.

1.  **HTML5 Drag and Drop API (Frontend - `TreeView.tsx`):**
    *   Tree items (`<li>`) are made draggable by setting the `draggable="true"` attribute.
    *   Event handlers (`onDragStart`, `onDragOver`, `onDragLeave`, `onDrop`) are implemented.
    *   `onDragStart`: Stores the `absolutePath` of the dragged node in a state variable.
    *   `onDragOver`: Prevents the default behavior to allow dropping and adds a CSS class (`.drop-target`) to valid folder nodes to provide visual feedback.
    *   `onDrop`: Captures the dragged path and the drop target path, then sends a new `RequestMoveFile` IPC message to the backend.
2.  **IPC Channel:**
    *   A `ClientToServerChannel.RequestMoveFile` channel was created, carrying a payload of `{ oldPath: string, newPath: string }`.
3.  **Backend Logic (`fs.service.ts`):**
    *   A new handler for `RequestMoveFile` was created. It uses `vscode.workspace.fs.rename()` to perform the actual file system move.
4.  **State Preservation (`selection.service.ts`):**
    *   After a successful move, the backend calls a new method in the `SelectionService` to update all persisted selections (both the last active selection and any named sets), replacing the `oldPath` with the `newPath`. This ensures that a file's "checked" state is preserved across moves.