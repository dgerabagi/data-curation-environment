# Artifact A23: DCE - Phase 1 - Advanced Interactions (Keyboard & Drag-Drop) Plan
# Date Created: C29
# Author: AI Model
# Updated on: C61 (Codify robust URI-based drag-and-drop solution from external sources)

- **Key/Value for A0:**
- **Description:** Details the requirements for implementing full keyboard navigation and drag-and-drop file/folder operations within the main file tree view.
- **Tags:** feature plan, keyboard navigation, drag and drop, file operations, accessibility, ux, phase 1

## 1. Overview & Goal

To achieve true feature parity with the native VS Code Explorer and cater to power users, the Data Curation Environment must support advanced interactions. This plan outlines the requirements for two major features: full keyboard navigation for accessibility and speed, and drag-and-drop functionality for intuitive file system manipulation.

## 2. User Stories

| ID | User Story | Acceptance Criteria |
|---|---|---|
| AI-01 | **Keyboard Navigation** | As a power user, I want to navigate the file tree using only my keyboard, so I can find, select, and manage files without taking my hands off the keyboard. | - Arrow Up/Down keys move the focus between visible nodes. <br> - Arrow Right on a collapsed folder expands it. <br> - Arrow Left on an open folder collapses it. <br> - `Enter` key opens the focused file or toggles expansion. <br> - `Spacebar` toggles the checkbox of the focused node. |
| AI-02 | **Internal Drag-and-Drop** | As a user, I want to be able to drag a file or folder and drop it into another folder within the DCE view to move it, so I can reorganize my project intuitively. | - Clicking and dragging a file or folder initiates a drag operation. <br> - Dragging over a folder highlights it as a potential drop target. <br> - Dropping a file/folder onto another folder moves the dragged item. <br> - **Validation:** A folder cannot be dropped into itself or one of its own descendants. |
| AI-03 | **External Drag-and-Drop** | As a user, I want to drag a file (e.g., a PDF) from my computer's file explorer or the VS Code Explorer and drop it into a folder in the DCE view to add it to my project, so I can quickly incorporate new assets. | - Dragging a file from the OS or VS Code Explorer and dropping it onto a folder in the DCE view copies that file into the target folder in the workspace. <br> - The file tree automatically refreshes to show the newly added file. |
| AI-06 | **Hover to Expand Folder** | As a user dragging a file, when I hover over a collapsed folder for a moment, I want it to automatically expand, so I can drop the file into a nested subdirectory without having to cancel the drag operation. | - During a drag operation, hovering over a collapsed folder for ~500ms triggers its expansion. <br> - Moving the mouse away from the folder before the timer completes cancels the expansion. |

## 3. Technical Implementation Plan

### Keyboard Navigation & Internal Drag-Drop (Completed)
These features are stable and complete. The internal drag-drop includes robust validation to prevent invalid moves.

### External Drag and Drop (Implementation C61)
This requires a multi-layered strategy to correctly handle drops from different sources (OS vs. VS Code Explorer) due to webview security constraints.

1.  **Problem:** When dragging from the native VS Code Explorer, the `DataTransfer` object does **not** contain `File` objects for security reasons. Instead, it contains a URI string in the `text/uri-list` data type. The webview cannot access the file system with this URI directly. Drops from the OS *do* use the standard `Files` API.

2.  **Solution:**
    *   **Frontend Drop Handler (`view.tsx`, `TreeView.tsx`):** The `onDrop` handler must be multi-faceted.
        1.  It must first check `event.dataTransfer.files`. If it has a `length > 0`, it's a drop from the OS. The handler will read the files as buffers and send them to the backend via the existing `RequestAddFileFromBuffer` IPC channel.
        2.  If `event.dataTransfer.files` is empty, it must then check `event.dataTransfer.getData('text/uri-list')`. If this returns a non-empty string, it's a drop from the VS Code Explorer.
        3.  The handler will parse this string (which is a URI like `file:///c:/path/to/file.txt`) and send it to the backend via a **new IPC channel**: `RequestCopyFileFromUri`.
    *   **New IPC Channel (`RequestCopyFileFromUri`):** A new channel will be created to pass the source URI string and the target directory path from the frontend to the backend.
    *   **Backend Handler (`fs.service.ts`):** A new message handler for `RequestCopyFileFromUri` will be created. It will:
        1.  Convert the source URI string into a `vscode.Uri` object.
        2.  Construct a destination `vscode.Uri` object by combining the target directory path and the basename of the source file.
        3.  Use the `vscode.workspace.fs.copy()` API to perform the file operation. This is the secure and correct way for the extension host to act on a URI provided by the webview.
    *   **Logging:** The drop handlers will include detailed logging to inspect all available `event.dataTransfer.types` to ensure robustness.