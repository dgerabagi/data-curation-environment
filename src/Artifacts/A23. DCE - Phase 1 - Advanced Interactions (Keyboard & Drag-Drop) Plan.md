# Artifact A23: DCE - Phase 1 - Advanced Interactions (Keyboard & Drag-Drop) Plan
# Date Created: C29
# Author: AI Model
# Updated on: C55 (Refine technical plan for external drag-and-drop with detailed event flow)

- **Key/Value for A0:**
- **Description:** Details the requirements for implementing full keyboard navigation and drag-and-drop file/folder operations within the main file tree view.
- **Tags:** feature plan, keyboard navigation, drag and drop, file operations, accessibility, ux, phase 1

## 1. Overview & Goal

To achieve true feature parity with the native VS Code Explorer and cater to power users, the Data Curation Environment must support advanced interactions. This plan outlines the requirements for two major features: full keyboard navigation for accessibility and speed, and drag-and-drop functionality for intuitive file system manipulation.

## 2. User Stories

| ID | User Story | Acceptance Criteria |
|---|---|---|
| AI-01 | **Keyboard Navigation** | As a power user, I want to navigate the file tree using only my keyboard, so I can find, select, and manage files without taking my hands off the keyboard. | - Arrow Up/Down keys move the focus between visible nodes. <br> - Arrow Right on a collapsed folder expands it. <br> - Arrow Right on an open folder or file moves focus to the first child. <br> - Arrow Left on an open folder collapses it. <br> - Arrow Left on a child node moves focus to its parent. <br> - `Enter` key opens the focused file or toggles expansion for a focused folder. <br> - `Spacebar` toggles the checkbox of the focused node. |
| AI-02 | **Internal Drag-and-Drop** | As a user, I want to be able to drag a file or folder and drop it into another folder within the DCE view to move it, so I can reorganize my project intuitively. | - Clicking and dragging a file or folder in the tree initiates a drag operation. <br> - Dragging over a folder highlights it as a potential drop target. <br> - Dropping a file/folder onto another folder moves the dragged item into the target folder. <br> - The backend file system is updated, and the tree view refreshes to reflect the new structure. |
| AI-03 | **External Drag-and-Drop** | As a user, I want to drag a file (e.g., a PDF) from my computer's file explorer and drop it into a folder in the DCE view to add it to my project, so I can quickly incorporate new assets. | - Dragging a file from the OS and dropping it onto a folder in the DCE view copies that file into the target folder in the workspace. <br> - The backend file system is updated. <br> - The file tree automatically refreshes to show the newly added file. |
| AI-04 | **Select All in Selected List** | As a user, after curating a list, I want to click in the "Selected Items" panel and press `Ctrl+A` or use a context menu to select all files in that list, so I can quickly perform a batch action like "Remove selected". | - **(C37 Update)** Right-clicking in the "Selected Items" list shows a context menu with a "Select All" option. <br> - Clicking it selects all items currently rendered in the list. <br> - The "Remove selected" button's count updates to reflect the total number of items in the list. |
| AI-05 | **Delete Key to Remove Selection** | As a user, when I have items selected in the "Selected Items" panel, I want to press the `Delete` key to remove them, so I can manage my list more quickly. | - When the "Selected Items" list has focus, pressing the `Delete` key performs the same action as clicking the "Remove selected" button. <br> - All currently selected items are removed from the overall checked files list. <br> - The local selection within the "Selected Items" panel is cleared. |

## 3. Technical Implementation Plan

### Keyboard Navigation (Completed)
The focus management and event handling for keyboard navigation are complete and stable.

### Internal Drag and Drop (Completed)
The HTML5 Drag and Drop API implementation within the React webview is complete and functional.

### External Drag and Drop (Implementation C55)
This requires a multi-layered event handling strategy to provide clear visual feedback and robust functionality.

1.  **Main Container Handlers (`view.tsx`):**
    *   The main `div.view-container` will have `onDragEnter`, `onDragOver`, `onDragLeave`, and `onDrop` handlers.
    *   `onDragEnter` and `onDragLeave` will toggle a component-level state (`isDragging`) which adds a `.drag-over` class to the container, providing a visual border around the entire view. **Crucially, they must call `event.preventDefault()` and `event.stopPropagation()` and include logging.**
    *   `onDragOver` **must** call `event.preventDefault()` to signal that the container is a valid drop zone. This is the key to making the `onDrop` event fire.
    *   `onDrop` on this container acts as a fallback. If a user drops a file on an empty area of the view, this handler will trigger and treat the project's root directory as the target. It will contain the `FileReader` and IPC logic.

2.  **Individual Node Handlers (`TreeView.tsx`):**
    *   The generic `TreeView` component will be enhanced to handle drag events on its `<li>` elements.
    *   It will manage a local state (`dropTarget: string | null`) to track the path of the node currently being hovered over.
    *   `onDragEnter`: Will be attached to each `<li>`. It will call `event.stopPropagation()` to prevent the container's handler from firing. It will check if the node is a directory and, if so, call `setDropTarget` with its path.
    *   `onDragLeave`: Will clear the `dropTarget` state.
    *   `onDrop`: Will be attached to each `<li>`. It will call `event.stopPropagation()` and then call a new prop function, `onNodeDrop(event, node)`, delegating the file processing logic to a more specialized parent component. The `className` will be updated to reflect the `drop-target` state for highlighting.

3.  **File Processing Logic (`FileTree.tsx`):**
    *   The `FileTree` component will define the `handleNodeDrop` function and pass it as the `onNodeDrop` prop to `TreeView`.
    *   `handleNodeDrop`: This function receives the drop event and the target `FileNode`. It will determine the final target directory (the node's path if it's a directory, or its parent's path if it's a file). It will then execute the `FileReader` logic to read the dropped files and send them to the backend via the `RequestAddFileFromBuffer` IPC message. **This function will contain extensive logging.**

4.  **Backend (`fs.service.ts`):**
    *   The existing `handleAddFileFromBuffer` handler is sufficient. It receives the full target path and the file's buffer, writes the file, and relies on the existing `FileSystemWatcher` to trigger a UI refresh.