# Artifact A120: DCE - Database Maintenance Guide
# Date Created: C126
# Author: AI Model & Curator

- **Key/Value for A0:**
- **Description:** A guide for developers on how to maintain, migrate, and debug the SQLite database used by the DCE extension.
- **Tags:** guide, database, sqlite, maintenance, migration, debugging

## 1. Overview

The Data Curation Environment (DCE) uses a local SQLite database (`.vscode/dce.db`) to store project history, cycles, and responses. This ensures data integrity and performance. This guide outlines the procedures for maintaining this database, including schema migrations, debugging, and manual editing.

## 2. Database Location

The database is located in the user's workspace:
*   **Path:** `.vscode/dce.db`
*   **WAL File:** `.vscode/dce.db-wal` (Write-Ahead Log - do not delete while DB is open)
*   **SHM File:** `.vscode/dce.db-shm` (Shared Memory - do not delete while DB is open)

## 3. Schema Management & Migrations

As the extension evolves, the database schema will need to change (e.g., adding new columns for new features).

### 3.1. Adding a New Column
To add a new column to an existing table (e.g., `cycles`):

1.  **Modify `pcpp.types.ts`:** Update the TypeScript interface (e.g., `PcppCycle`) to include the new property.
2.  **Update `DatabaseService.ts`:**
    *   **`createTables()`:** Update the `CREATE TABLE` statement to include the new column for *new* databases.
    *   **`migrateSchema()` (New Method):** Implement a migration check.
        ```typescript
        private migrateSchema() {
            // Example: Check if 'is_cycle_collapsed' exists
            const tableInfo = this.db.pragma('table_info(cycles)') as any[];
            const hasColumn = tableInfo.some(col => col.name === 'is_cycle_collapsed');
            
            if (!hasColumn) {
                this.db.exec('ALTER TABLE cycles ADD COLUMN is_cycle_collapsed INTEGER DEFAULT 0');
                Services.loggerService.log('Migrated database: Added is_cycle_collapsed to cycles table.');
            }
        }
        ```
    *   **`initialize()`:** Call `this.migrateSchema()` after `createTables()`.
3.  **Update `HistoryService.ts`:** Ensure the `saveCycle` and `getCycle` methods map the new TypeScript property to the new database column.

### 3.2. Breaking Changes
If a change requires a complete schema restructure (rare), it is often safer to:
1.  Rename the existing table (e.g., `cycles_v1`).
2.  Create the new table (`cycles`).
3.  Run a migration script to copy/transform data from `cycles_v1` to `cycles`.
4.  Drop `cycles_v1`.

## 4. Debugging & Inspection

To inspect the database contents during development:

1.  **VS Code Extensions:** Use an extension like "SQLite" or "SQLite Viewer" to open `.vscode/dce.db` directly within VS Code.
2.  **CLI:** Use the `sqlite3` command-line tool:
    ```bash
    sqlite3 .vscode/dce.db "SELECT id, title, status FROM cycles ORDER BY id DESC LIMIT 5;"
    ```
3.  **Logs:** The `DatabaseService` logs all major operations and errors to the "Data Curation Environment" output channel.

## 5. Backup & Recovery

*   **Automatic Backup:** The legacy `dce_history.json` is renamed to `dce_history.json.bak` upon migration.
*   **Manual Export:** Users can export their history to JSON via the "Export History" button in the PCPP. This JSON can be re-imported to rebuild the database.