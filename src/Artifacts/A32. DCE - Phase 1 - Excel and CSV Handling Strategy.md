# Artifact A32: DCE - Phase 1 - Excel and CSV Handling Strategy
# Date Created: C62
# Author: AI Model
# Updated on: C66 (Switch to exceljs and custom Markdown converter)

- **Key/Value for A0:**
- **Description:** Defines the strategy for handling tabular data files (.xlsx, .xls, .csv) by converting them to Markdown tables on-demand and caching them in memory for flattening.
- **Tags:** feature plan, excel, csv, text extraction, virtualization, cache, phase 1

## 1. Overview & Goal

Following the successful implementation of PDF virtualization, users now require a similar capability for tabular data files, specifically Microsoft Excel (`.xlsx`, `.xls`) and Comma-Separated Values (`.csv`). The goal is to extract the content from these files and represent it as clean, readable Markdown tables within the flattened context. This will be achieved using the same on-demand, in-memory caching strategy to avoid creating temporary files in the user's workspace.

## 2. User Stories

| ID | User Story | Acceptance Criteria |
|---|---|---|
| XLS-01 | **Include Tabular Data in Context** | As a user, when I check an Excel or CSV file, I want its data to be converted to Markdown tables and included in the `flattened_repo.md`, so I can use structured data as context for the LLM. | - Checking `.xlsx`, `.xls`, and `.csv` files is allowed. <br> - The token count displayed for the file reflects its Markdown table content. <br> - When flattened, the content is included within a `<file>` tag. <br> - For Excel files with multiple sheets, each sheet is converted to a separate named Markdown table. <br> - No temporary `.md` files are created in the user's workspace. |

## 3. Technical Implementation Plan (C66 Update)

1.  **Dependency:**
    *   The `xlsx` (SheetJS) library has been removed due to a high-severity vulnerability and persistent bundling issues.
    *   It has been replaced with the **`exceljs`** package, a modern and well-maintained library for parsing various spreadsheet formats. This will be added as a dependency in `package.json`.

2.  **Backend (`fs.service.ts`):**
    *   **In-Memory Cache:** A private cache will be maintained: `private excelMarkdownCache = new Map<string, { markdown: string; tokenCount: number }>();`.
    *   **New IPC Handler (`RequestExcelToText`):**
        *   This handler will receive a file path. It will first check the cache.
        *   If not cached, it will read the file buffer.
        *   It will use `workbook.xlsx.load(buffer)` from `exceljs` to parse the file.
        *   It will iterate through each worksheet in the workbook.
        *   For each sheet, it will call a new **custom private helper method, `_worksheetToMarkdown`**.
    *   **Custom Markdown Converter (`_worksheetToMarkdown`):**
        *   This new function will take an `exceljs` worksheet object as input.
        *   It will iterate through the worksheet's rows to determine the table headers and data.
        *   It will manually construct a Markdown table string by creating the header row (`| Col1 | Col2 |`), the separator line (`|---|---|`), and each data row (`| Val1 | Val2 |`).
        *   This custom implementation gives us full control over the output and resolves the previous runtime errors.
        *   The final Markdown string (including headers for each sheet) will be concatenated, its token count calculated, and the result stored in the cache.
        *   It will then send an `UpdateNodeStats` message back to the client with the new token count.

3.  **Frontend & Flattener Integration:**
    *   The frontend (`view.tsx`) will continue to trigger the `RequestExcelToText` message on-demand when a relevant file is checked.
    *   The backend (`flattener.service.ts`) will continue to retrieve the virtual Markdown content from the `FSService`'s cache when flattening. No changes are needed in these files.