# Artifact A32: DCE - Phase 1 - Excel and CSV Handling Strategy
# Date Created: C62
# Author: AI Model

- **Key/Value for A0:**
- **Description:** Defines the strategy for handling tabular data files (.xlsx, .xls, .csv) by converting them to Markdown tables on-demand and caching them in memory for flattening.
- **Tags:** feature plan, excel, csv, text extraction, virtualization, cache, phase 1

## 1. Overview & Goal

Following the successful implementation of PDF virtualization, users now require a similar capability for tabular data files, specifically Microsoft Excel (`.xlsx`, `.xls`) and Comma-Separated Values (`.csv`). The goal is to extract the content from these files and represent it as clean, readable Markdown tables within the flattened context. This will be achieved using the same on-demand, in-memory caching strategy to avoid creating temporary files in the user's workspace.

## 2. User Stories

| ID | User Story | Acceptance Criteria |
|---|---|---|
| XLS-01 | **Include Tabular Data in Context** | As a user, when I check an Excel or CSV file, I want its data to be converted to Markdown tables and included in the `flattened_repo.md`, so I can use structured data as context for the LLM. | - Checking `.xlsx`, `.xls`, and `.csv` files is allowed. <br> - The token count displayed for the file reflects its Markdown table content. <br> - When flattened, the content is included within a `<file>` tag. <br> - For Excel files with multiple sheets, each sheet is converted to a separate named Markdown table. <br> - No temporary `.md` files are created in the user's workspace. |

## 3. Technical Implementation Plan

1.  **Dependency:**
    *   The `xlsx` package (the community edition of `sheetjs`) will be added as a dependency to `package.json`. It is a robust, widely-used library for parsing various spreadsheet formats.

2.  **Backend (`fs.service.ts`):**
    *   **File Identification:** A new set of `EXCEL_EXTENSIONS` (`.xlsx`, `.xls`, `.csv`) will be defined. The `getFileStats` method will be updated to set an `isExcel` flag on the `FileNode` for these files.
    *   **In-Memory Cache:** A new private cache will be added: `private excelMarkdownCache = new Map<string, { markdown: string; tokenCount: number }>();`.
    *   **New IPC Handler (`RequestExcelToText`):**
        *   This handler will receive a file path. It will first check the cache.
        *   If not cached, it will read the file buffer.
        *   It will use `xlsx.read(buffer)` to parse the file.
        *   For each sheet in the workbook (`workbook.SheetNames`), it will use `xlsx.utils.sheet_to_markdown(worksheet)` to get the Markdown table.
        *   It will prepend each table with a header indicating the sheet name (e.g., `### Sheet: Sheet1`).
        *   The final Markdown string will be concatenated, its token count calculated, and the result stored in the cache.
        *   It will then send an `UpdateNodeStats` message back to the client with the new token count.

3.  **Frontend (`view.tsx`):**
    *   **On-Demand Extraction:** The `updateCheckedFiles` function will be modified. When a path matching one of the `EXCEL_EXTENSIONS` is checked for the first time, it will send a `RequestExcelToText` message to the backend.

4.  **Backend (`flattener.service.ts`):**
    *   **Virtual Content Retrieval:** The `getFileStatsAndContent` method will be updated.
    *   If it encounters a file with an Excel/CSV extension, it will call a new method on `FSService` (e.g., `getVirtualExcelContent(filePath)`) to retrieve the Markdown from the `excelMarkdownCache`.
    *   It will use this cached Markdown as the file's content for flattening.

5.  **UI (`FileTree.tsx`):**
    *   The `getFileIcon` function will be updated to display an appropriate icon (e.g., a grid or table icon) for files with Excel/CSV extensions.