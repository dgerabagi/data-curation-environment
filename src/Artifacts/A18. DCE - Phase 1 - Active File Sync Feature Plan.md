# Artifact A18: DCE - Phase 1 - Active File Sync Feature Plan
# Date Created: Cycle 24
# Author: AI Model
# Updated on: C30 (Add debugging notes regarding path normalization)

- **Key/Value for A0:**
- **Description:** Details the requirements and implementation for automatically revealing and highlighting the active editor's file in the custom Data Curation file tree.
- **Tags:** feature plan, active file, sync, reveal, tree view, ux, phase 1

## 1. Overview & Goal

To create a more seamless and integrated experience, the Data Curation Environment's file tree should stay in sync with the user's focus in the main editor. Currently, selecting a file in the editor does not reflect in our custom view. The goal of this feature is to replicate the behavior of the native VS Code Explorer, where the active file is automatically revealed and highlighted in the file tree.

## 2. User Story

| ID | User Story | Acceptance Criteria |
|---|---|---|
| UX-01 | **Sync with Active Editor** | As a user, when I click on a file in the VS Code editor tabs or the native Explorer, I want the "Data Curation" file tree to automatically scroll to and highlight that file, so I can easily see its location in the project hierarchy and interact with its checkbox without manually searching for it. | - When the active text editor changes in VS Code, the new file is highlighted in the "Data Curation" tree view. <br> - All parent folders of the active file are automatically expanded to ensure it is visible. <br> - The file tree view scrolls so that the active file item is visible on the screen. |

## 3. Technical Implementation Plan

1.  **Backend Listener (`extension.ts`):**
    *   Utilize the `vscode.window.onDidChangeActiveTextEditor` event listener in the `activate` function.
    *   This event provides the `TextEditor` object, from which `editor.document.uri.fsPath` can be extracted.
    *   When the event fires and an editor is present, the backend will normalize the file path (to use forward slashes) and send an IPC message to the webview containing the active file's path.

2.  **IPC Channel:**
    *   The existing `ServerToClientChannel.SetActiveFile` will be used.
    *   Its `ChannelBody` in `channels.type.ts` is `{ path: string }`.

3.  **Frontend Message Handler (`view.tsx`):**
    *   The main `App` component will listen for the `SetActiveFile` message from the backend.
    *   Upon receiving the message, it will update its `activeFile` state with the new path. This state will be passed down to the `TreeView` component via `FileTree`.

4.  **Frontend View Logic (`TreeView.tsx`):**
    *   A new `useEffect` hook will be added to the `TreeView` component that triggers whenever the `activeFile` prop changes.
    *   This effect will be responsible for "revealing" the file:
        *   **Expand Parents:** It will calculate all parent directory paths of the `activeFile`. This can be done by repeatedly taking the substring of the path before the last file separator (`/`). These parent paths will be added to the `expandedNodes` state.
        *   **Scroll Into View:** To physically scroll the element, a `Map` of `ref`s will be maintained for each rendered file/folder node. After expanding the parents, the `scrollIntoView()` method will be called on the ref corresponding to the `activeFile`. A short `setTimeout` will be used to ensure the DOM has updated with the expanded nodes before scrolling.

## 4. Debugging Notes & Regression Prevention

-   **Root Cause of C30 Regression:** The feature failed because of a path normalization mismatch. The `editor.document.uri.fsPath` property from the VS Code API returns paths with **backslashes (`\`)** on Windows. The frontend webview components, however, exclusively use and expect **forward slashes (`/`)** for path comparisons and manipulations.
-   **Codified Solution:** The path from the `onDidChangeActiveTextEditor` event **must** be normalized to use forward slashes *before* it is sent to the frontend via the IPC channel.
    ```typescript
    // Correct implementation in extension.ts
    const filePath = editor.document.uri.fsPath.replace(/\\/g, '/');
    serverIpc.sendToClient(ServerToClientChannel.SetActiveFile, { path: filePath });
    ```
-   **Best Practice:** All path strings originating from the backend that are intended for consumption by the frontend must be normalized to use forward slashes to ensure platform-agnostic consistency.