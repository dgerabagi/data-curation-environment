# Artifact A86: DCE - PCPP Workflow Centralization and UI Persistence Plan
# Date Created: C19
# Author: AI Model & Curator
# Updated on: C21 (Re-add requirement for Select All buttons)

- **Key/Value for A0:**
- **Description:** A plan to centralize the main workflow buttons in the PCPP, make the animated workflow highlight persistent, and fix the broken cost calculation.
- **Tags:** feature plan, ui, ux, workflow, refactor, bug fix

## 1. Overview & Goal

User feedback from Cycle 19 identified three key areas for improvement in the Parallel Co-Pilot Panel (PCPP):
1.  **Scattered UI:** The buttons for the core workflow are located in different places, making the process unintuitive.
2.  **Ephemeral UI State:** The animated highlight that guides the user disappears if they switch away from the PCPP tab.
3.  **Broken Metric:** The total estimated cost calculation is non-functional.

The goal of this plan is to address all three issues to create a more intuitive, robust, and functional user experience.

## 2. The User Workflow Articulated

To centralize the buttons effectively, we must first define the ideal user workflow as a sequence of steps.

1.  **Paste & Parse:** User pastes responses into tabs. Clicks **`Parse All`**.
2.  **Sort & Select:** User reviews metadata. Clicks **`Sort`** to order responses. Clicks **`Select This Response`** on the most promising one.
3.  **Baseline (Optional):** User may click **`Baseline (Commit)`** to save the current state before testing.
4.  **Accept:** User checks files in the "Associated Files" list and clicks **`Accept Selected`**.
5.  **Test & Restore (Loop):** User tests the applied changes. If they fail, the user clicks **`Restore Baseline`** and returns to Step 4 to test a different set of files or a different response.
6.  **Finalize & Proceed:** Once satisfied, the user provides a cycle title/context and clicks **`Generate prompt.md`** and then **`+`** to start the next cycle.

## 3. Button Centralization Plan

### 3.1. ASCII Mockup of New Toolbar

The new, centralized toolbar will be located directly below the response tabs, making it the central point of interaction.

```
|=================================================================================================|
| [ Resp 1 (5 files, 2.1K tk) ] [ Resp 2 (4 files, 1.8K tk) ] [ Resp 3 ] [ Resp 4 ]      [ Sort ] |
|-------------------------------------------------------------------------------------------------|
|                                                                                                 |
|   +-----------------------------------------------------------------------------------------+   |
|   | [ Parse All ] [ Select This Resp ] [ Baseline ] [ Restore ] [ Accept Selected ]         |   |
|   +-----------------------------------------------------------------------------------------+   |
|                                                                                                 |
| | [v] Associated Files (5) [Select All] [Deselect All Across Responses]                     | | |
| |-------------------------------------------------------------------------------------------| | |
| | [✓] [ ] src/Artifacts/A86. ... .md                                                        | | |
| | [✓] [ ] src/client/views/.../view.tsx                                                     | | |
| | ...                                                                                       | | |
|-------------------------------------------------------------------------------------------------|```

### 3.2. Technical Implementation
-   A new component, `src/client/views/parallel-copilot.view/components/WorkflowToolbar.tsx`, will be created.
-   It will contain all the buttons related to the main workflow.
-   **(C21 Update):** The "Select All" and "Deselect All Across Responses" buttons, which were lost in a previous refactor, will be re-added to the toolbar to provide critical batch selection functionality for associated files.
-   The main `view.tsx` will manage the state for enabling/disabling these buttons and pass the state and `onClick` handlers down as props.
-   The buttons will be removed from their old locations (the main header and the `ParsedView` header). The "Select This Response" button will now act on the currently active tab.

## 4. Persistent Animation Plan

-   **Problem:** The `workflowStep` state is currently a local `useState` in `view.tsx`, which is lost when the webview is hidden and shown again.
-   **Solution:** The `workflowStep` will be elevated to become part of the persisted cycle state.
    1.  **Type Definition:** Add `activeWorkflowStep?: string;` to the `PcppCycle` interface in `src/common/types/pcpp.types.ts`.
    2.  **State Management:** The `saveCurrentCycleState` function in `view.tsx` will now also update the main `PcppCycle` object with the current `workflowStep`.
    3.  **Restoration:** When a cycle is loaded, the `activeWorkflowStep` from the loaded data will be used to initialize the state, ensuring the highlight is correctly re-applied.

## 5. Cost Calculation Fix Plan

-   **Problem:** The total estimated cost always shows `$0.00`.
-   **Investigation:** The cost is calculated based on a `totalPromptTokens` state, which is populated by a message from the backend. The request for this calculation is debounced and triggered by changes to the cycle context or title. It appears this request is not being triggered on the initial load of a cycle.
-   **Solution:**
    1.  In `view.tsx`, locate the `useEffect` hook that handles the `SendInitialCycleData` and `SendCycleData` messages.
    2.  Inside this hook, after the component's state is updated with the new cycle data, add a direct call to the `requestCostEstimation()` function.
    3.  This will ensure that a cost estimation is requested from the backend every time a cycle is loaded, fixing the bug and displaying an accurate cost.