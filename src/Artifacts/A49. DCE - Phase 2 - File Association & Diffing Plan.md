# Artifact A49: DCE - Phase 2 - File Association & Diffing Plan
# Date Created: C82
# Author: AI Model
# Updated on: C98 (Escalate debugging plan with direct JSX logging)

- **Key/Value for A0:**
- **Description:** Plans the UI and backend logic to visually link file blocks in an AI response to workspace files and sets the stage for an integrated diff tool.
- **Tags:** feature plan, phase 2, ui, ux, diff, file association

## 1. Overview & Goal

To make the "Swap with Source" feature trustworthy and intuitive, users need a clear visual confirmation of which local file an AI-generated code block is intended to replace. This feature introduces a "file association" mechanism that parses AI responses, verifies the existence of the mentioned files, and displays this status to the user.

**Update (C95):** This plan is now evolved. The "Associated Files" list is not just for verification but is the primary interaction point for viewing changes. Clicking a file in this list now drives the UI, displaying a diff view in an adjacent panel.

## 2. User Stories

| ID | User Story | Acceptance Criteria |
|---|---|---|
| P2-ASSOC-01 | **See Affected Files** | As a developer, when I parse an AI response, I want the extension to automatically show me a list of all the file paths it intends to modify, so I can understand the scope of the proposed changes. | - After parsing, a collapsible "Associated Files" section appears in the tab's UI. <br> - This section displays a list of all file paths found in the response. |
| P2-ASSOC-02 | **Verify File Existence** | As a developer, for each file listed, I want to see a visual indicator of whether that file already exists in my workspace, so I can spot potential errors or new files proposed by the AI. | - Next to each listed file path, an icon is displayed. <br> - A green checkmark (`✓`) indicates the file exists at that path. <br> - A red cross (`✗`) indicates the file does not exist, alerting me to a potential hallucination or a new file creation. |
| P2-ASSOC-03 | **Preview Changes with Diff** | As a developer, I want to click on an existing file in the "Associated Files" list to immediately see a side-by-side comparison of the original file and the AI's proposed changes, so I can review the changes before swapping. | - Clicking a file with a `✓` in the list opens a diff view in a new panel to the right. <br> - The diff view clearly shows added, removed, and common lines. <br> - The diff view is the primary way to inspect changes. |

## 3. Technical Implementation Plan (C98)

1.  **Frontend - Parsing (`response-parser.ts`):**
    *   **Status:** **Complete.** The parser has been enhanced to check for angle-bracket paths first.

2.  **Backend - Verification & Content Fetching (`fs.service.ts`):**
    *   **Status:** **Complete.** The `handleFileExistenceRequest` and `handleFileContentRequest` handlers are implemented.

3.  **Frontend - UI & State (`view.tsx`):**
    *   **Status:** **Debugging.** The diff view is not appearing on click. The lack of logs indicates the event is not being captured or the IPC message is not being sent.
    *   **Workflow:**
        1.  User clicks a file in the list.
        2.  The `onClick` handler calls a function, `handleSelectForDiff`.
        3.  `handleSelectForDiff` sets the `diffTarget` state and sends a `RequestFileContent` IPC message.
        4.  The `onmessage` handler for `SendFileContent` receives the original file's text and sets the `originalFileContent` state.
        5.  The `DiffViewer` component renders when `diffTarget` and `originalFileContent` are both non-null.
    *   **Debugging Plan (C98 - Escalated):**
        *   **Step 1 (Client - JSX):** Add `onClick={() => logger.log('Associated file LI clicked: ' + file.path)}` directly to the `<li>` element in the `AssociatedFilesList` component. This is the most critical diagnostic step. If this log does not appear, the event is being blocked by styling or another element before React can handle it.
        *   **Step 2 (Client - Handler):** Add `logger.log()` inside `handleSelectForDiff` to confirm it's being called by the `onClick`.
        *   **Step 3 (Client - IPC Send):** Add `logger.log()` immediately before the `clientIpc.sendToServer(ClientToServerChannel.RequestFileContent, ...)` call.
        *   **Step 4 (Backend - IPC Receive):** Add `loggerService.log()` at the very beginning of the `on-message.ts` handler for `ClientToServerChannel.RequestFileContent`.
        *   **Step 5 (Backend - Service):** Add `loggerService.log()` at the beginning of the `handleFileContentRequest` method in `fs.service.ts`.
        *   **Step 6 (Client - IPC Receive):** Add `logger.log()` at the beginning of the `onServerMessage` handler for `ServerToClientChannel.SendFileContent` in `view.tsx`.
        *   **Step 7 (Client - State):** Add `console.log({ diffTarget, originalFileContent })` just before the `return` statement in the `App` component to inspect state on every render.