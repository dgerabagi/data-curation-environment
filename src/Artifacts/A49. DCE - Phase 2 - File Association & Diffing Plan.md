# Artifact A49: DCE - Phase 2 - File Association & Diffing Plan
# Date Created: C82
# Author: AI Model
# Updated on: C101 (Simplify to staged approach: single view first, then diff)

- **Key/Value for A0:**
- **Description:** Plans the UI and backend logic to visually link file blocks in an AI response to workspace files and sets the stage for an integrated diff tool.
- **Tags:** feature plan, phase 2, ui, ux, diff, file association

## 1. Overview & Goal

To make the "Swap with Source" feature trustworthy and intuitive, users need a clear visual confirmation of which local file an AI-generated code block is intended to replace. This feature introduces a "file association" mechanism that parses AI responses, verifies the existence of the mentioned files, and displays this status to the user.

**Update (C101):** This plan is now a two-stage implementation to address a persistent bug. The immediate goal is simplified to rendering a single, syntax-highlighted view of the AI-generated code. The more complex diff view will be re-introduced only after the single-view functionality is stable and confirmed to be working.

## 2. User Stories

| ID | User Story | Acceptance Criteria |
|---|---|---|
| P2-ASSOC-01 | **See Affected Files** | As a developer, when I parse an AI response, I want the extension to automatically show me a list of all the file paths it intends to modify, so I can understand the scope of the proposed changes. | - After parsing, a collapsible "Associated Files" section appears in the tab's UI. <br> - This section displays a list of all file paths found in the response. |
| P2-ASSOC-02 | **Verify File Existence** | As a developer, for each file listed, I want to see a visual indicator of whether that file already exists in my workspace, so I can spot potential errors or new files proposed by the AI. | - Next to each listed file path, an icon is displayed. <br> - A green checkmark (`✓`) indicates the file exists at that path. <br> - A red cross (`✗`) indicates the file does not exist. |
| P2-ASSOC-03 | **Preview AI Code (Stage 1)** | As a developer, I want to click on an existing file in the "Associated Files" list to immediately see a syntax-highlighted view of the AI's proposed code, so I can review the changes. | - Clicking a file with a `✓` in the list opens a single-pane view in the right-hand panel. <br> - This view displays only the AI's proposed code, with full syntax highlighting. <br> - The view automatically loads with the *first valid file* upon parsing. |
| P2-ASSOC-04 | **Preview Changes with Diff (Stage 2)** | As a developer, after Stage 1 is complete, I want the view to be enhanced to show a side-by-side comparison of the original file and the AI's proposed changes, so I can review the exact changes before swapping. | - The single-pane view is replaced with a two-pane diff component. <br> - The diff view clearly shows added, removed, and common lines. |

## 3. Technical Implementation Plan (C101)

1.  **Frontend - Parsing (`response-parser.ts`):**
    *   **Status:** **Complete.**

2.  **Backend - Verification & Highlighting (`fs.service.ts`):**
    *   **Status:** **Complete.** The `handleFileExistenceRequest` and `handleSyntaxHighlightRequest` handlers are working.

3.  **Frontend - UI & State (`view.tsx`):**
    *   **Status:** **Refactoring in Progress.**
    *   **State Simplification:** The `diffTarget` and `originalFileContent` state will be replaced with `selectedFileForViewing: ParsedFile | null` and `highlightedContent: string | null`.
    *   **Data Flow:**
        *   When a file is selected (manually or automatically), a `RequestSyntaxHighlight` message will be sent to the backend with the AI's proposed code.
        *   The handler for `SendSyntaxHighlight` will update the `highlightedContent` state.
        *   The `RequestFileContent` message will **not** be used in this stage.
    *   **Rendering:** The right pane will render a `div` using `dangerouslySetInnerHTML={{ __html: highlightedContent }}`. The `DiffViewer` component will be temporarily removed from the render path.
    *   **Debugging Plan (Ongoing):**
        *   **Step 1 (Hover Logging):** Add `onMouseEnter` and `onMouseLeave` handlers to the `<li>` element for each associated file to confirm basic mouse event registration.
        *   **Step 2 (Click Logging):** Ensure a `logger.log()` statement is the *very first line* inside the `onClick` handler for the `<li>` element. If hover logs appear but click logs do not, the event is being blocked.
        *   **Step 3 (Test Button):** A "Test View" button will bypass the list's `onClick` and directly trigger the `handleSelectForViewing` function for the first valid file, allowing for isolated testing of the backend highlighting pipeline.