# Artifact A49: DCE - Phase 2 - File Association & Diffing Plan
# Date Created: C82
# Author: AI Model

- **Key/Value for A0:**
- **Description:** Plans the UI and backend logic to visually link file blocks in an AI response to workspace files and sets the stage for an integrated diff tool.
- **Tags:** feature plan, phase 2, ui, ux, diff, file association

## 1. Overview & Goal

To make the "Swap with Source" feature trustworthy and intuitive, users need a clear visual confirmation of which local file an AI-generated code block is intended to replace. This feature introduces a "file association" mechanism that parses AI responses, verifies the existence of the mentioned files, and displays this status to the user. This is the foundational step required before an integrated diff tool can be built.

## 2. User Stories

| ID | User Story | Acceptance Criteria |
|---|---|---|
| P2-ASSOC-01 | **See Affected Files** | As a developer, when I paste an AI response, I want the extension to automatically parse it and show me a list of all the file paths it intends to modify, so I can understand the scope of the proposed changes. | - Pasting a response into a tab triggers a parsing event. <br> - A list of all file paths found in `<file path="...">` tags is displayed within the tab's UI. |
| P2-ASSOC-02 | **Verify File Existence** | As a developer, for each file listed, I want to see a visual indicator of whether that file already exists in my workspace, so I can spot potential errors or new files proposed by the AI. | - Next to each listed file path, an icon is displayed. <br> - A green checkmark (`✓`) indicates the file exists at that path. <br> - A red cross (`✗`) or question mark (`?`) indicates the file does not exist, alerting me to a potential hallucination or a new file creation. |
| P2-ASSOC-03 | **Preview Changes (Diff)** | As a developer, I want to click a "Diff" button next to an associated file to see a side-by-side comparison of the original file and the AI's proposed changes, so I can review the changes before swapping. | - A "Diff" button appears next to each file that is successfully associated (i.e., exists). <br> - Clicking it opens a diff view (modal or new tab) showing the changes. |

## 3. Technical Implementation Plan

1.  **Frontend - Parsing (`parallel-copilot.view/view.tsx`):**
    *   Implement the `onPaste` handler as detailed in `A46`. It will use a regex (`/<file path="([^"]+)">/g`) to extract an array of file paths from the pasted text.
    *   Store this array in the state for the active tab, e.g., `detectedFiles: string[]`.

2.  **Backend - Verification (`fs.service.ts`):**
    *   Create a new IPC channel, `RequestFileExistence`, that accepts `{ paths: string[] }`.
    *   Create a handler `handleFileExistenceRequest` in `fs.service.ts`. This handler will iterate through the received paths, check each one's existence using `vscode.workspace.fs.stat`, and return a map of the results. Using `stat` is better than `access` as it doesn't throw an error for non-existent files.
    *   Create a corresponding `SendFileExistence` channel that sends back `{ existenceMap: { [path: string]: boolean } }`.

3.  **Frontend - UI & State (`parallel-copilot.view/view.tsx`):**
    *   After parsing paths on paste, immediately send them to the backend via `RequestFileExistence`.
    *   Add a new state variable to store the result: `const [fileExistence, setFileExistence] = useState<{ [path: string]: boolean }>({});`.
    *   Listen for the `SendFileExistence` message and update this state.
    *   Create a new component, e.g., `AssociatedFilesList`. This component will receive the `detectedFiles` and `fileExistence` maps as props.
    *   It will render a list of the file paths. For each path, it will look up its status in the `fileExistence` map and display the appropriate icon (e.g., `VscCheck` or `VscError` from `react-icons/vsc`).

4.  **Diffing (Future Step):**
    *   The "Diff" button will initially be disabled or hidden.
    *   Its implementation will require a new IPC channel to request the content of the original file from the backend.
    *   A diffing library (like `diff`) will be used to compare the original content with the relevant section from the AI response.
    *   The result will be rendered in a new component, `DiffViewer`, as planned in `A43`.