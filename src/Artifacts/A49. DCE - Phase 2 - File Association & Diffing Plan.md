# Artifact A49: DCE - Phase 2 - File Association & Diffing Plan
# Date Created: C82
# Author: AI Model
# Updated on: C132 (Change workflow from 'swap' to 'accept/replace')

- **Key/Value for A0:**
- **Description:** Plans the UI and backend logic to visually link file blocks in an AI response to workspace files and sets the stage for an integrated diff tool.
- **Tags:** feature plan, phase 2, ui, ux, diff, file association

## 1. Overview & Goal

To make the Parallel Co-Pilot Panel's workflow trustworthy and intuitive, users need a clear visual confirmation of which local file an AI-generated code block is intended to modify. This feature introduces a "file association" mechanism that parses AI responses, verifies the existence of the mentioned files, and displays this status to the user.

The core workflow is now defined as **"accept/replace"**: a one-way copy of content from the AI response into the user's workspace files.

## 2. User Stories

| ID | User Story | Acceptance Criteria |
|---|---|---|
| P2-ASSOC-01 | **See Affected Files** | As a developer, when I parse an AI response, I want the extension to automatically show me a list of all the file paths it intends to modify, so I can understand the scope of the proposed changes. | - After parsing, a collapsible "Associated Files" section appears in the tab's UI. <br> - This section displays a list of all file paths found in the response. |
| P2-ASSOC-02 | **Verify File Existence** | As a developer, for each file listed, I want to see a visual indicator of whether that file already exists in my workspace, so I can spot potential errors or new files proposed by the AI. | - Next to each listed file path, an icon is displayed. <br> - A green checkmark (`✓`) indicates the file exists at that path. <br> - A red cross (`✗`) indicates the file does not exist. |
| P2-ASSOC-03 | **Preview AI Code** | As a developer, I want to click on a file in the "Associated Files" list to immediately see a syntax-highlighted view of the AI's proposed code, so I can review it. | - Clicking a file with a `✓` in the list opens a single-pane view in the right-hand panel. <br> - This view displays only the AI's proposed code, with full syntax highlighting. |
| P2-ASSOC-04 | **Preview Changes with Diff** | As a developer, I want a "View Diff" button to see a side-by-side comparison of the original file and the AI's proposed changes, so I can review the exact changes before accepting them. | - A "View Diff" button is available for the selected file. <br> - Clicking it replaces the single-pane view with a two-pane diff component. <br> - The diff view clearly shows added, removed, and common lines. |
| P2-ASSOC-05 | **Accept Changes** | As a developer, I want to be able to accept changes from the AI response into my workspace, either for a single file or for a batch of selected files. | - An "Accept this file" button replaces the content of the workspace file with the AI's version. <br> - A separate "Accept Selected Files" button performs a bulk replacement for all files checked in the "Associated Files" list. <br> - This is a one-way copy from the AI response to the workspace. |

## 3. Technical Implementation Plan

1.  **Frontend - Parsing (`response-parser.ts`):**
    *   **Status:** **Complete.**

2.  **Backend - Verification & Highlighting (`fs.service.ts`):**
    *   **Status:** **Complete.** The `handleFileExistenceRequest` and `handleSyntaxHighlightRequest` handlers are working.

3.  **Frontend - UI & State (`view.tsx`):**
    *   **Status:** **In Progress.**
    *   **File List & Diff View:** Implement the "Associated Files" list. Clicking a file fetches its content for diffing and displays the `DiffViewer` component.
    *   **Selection State:** Manage a `Set<string>` of `selectedFilesForReplacement` to track which files are checked.
    *   **Accept/Replace Logic:**
        *   The "Accept this file" button will trigger a new `RequestWriteFile` IPC message.
        *   The "Accept Selected Files" button will trigger a new `RequestBatchFileWrite` IPC message with an array of file paths and their new content.

4.  **Backend - File Writing (`file-operation.service.ts`):**
    *   **Status:** **To be implemented.**
    *   Implement `handleWriteFileRequest` and `handleBatchFileWrite` to receive new content and overwrite the corresponding files in the workspace using `vscode.workspace.fs.writeFile`.