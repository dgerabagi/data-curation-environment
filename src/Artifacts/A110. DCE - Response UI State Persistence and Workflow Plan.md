# Artifact A110: DCE - Response UI State Persistence and Workflow Plan
# Date Created: C96
# Author: AI Model & Curator

- **Key/Value for A0:**
- **Description:** A plan to fix the response UI state loss and workflow bugs by expanding the data model to include generation metrics, refactoring the backend to persist them, and updating the frontend UI to be driven by a per-response status.
- **Tags:** plan, bug fix, persistence, state management, ui, ux, workflow

## 1. Problem Statement

The response generation UI, while functional, suffers from several critical bugs that make it unreliable and unintuitive:
1.  **State Loss:** All metrics (timers, token counts, progress) are lost if the user navigates away from the PCPP tab and back.
2.  **Missing Persistence:** The valuable metrics gathered during generation are not saved to `dce_history.json`, meaning they are lost forever once the UI is re-rendered.
3.  **"Stuck UI":** The UI often gets stuck on the "Generating Responses" view even after all responses are complete, because it is incorrectly keying off the overall cycle's status instead of the individual response's status.
4.  **Incorrect Workflow:** The UI doesn't allow a user to view a completed response while others are still generating.
5.  **Title Bug:** The backend incorrectly renames new cycles to "Cycle X - Generating...", which breaks the user-driven title workflow.

## 2. The Solution: Per-Response State & Persistence

The root cause of these issues is that the generation metrics are transient UI state and the rendering logic is too simplistic. The solution is to make these metrics a persistent part of our data model and make the UI rendering logic more granular.

### 2.1. New Data Model

The `PcppResponse` interface in `pcpp.types.ts` will be expanded to become the single source of truth for a response and its generation metadata.

**New `PcppResponse` Interface:**
```typescript
export interface PcppResponse {
    content: string;
    // The single source of truth for the response's state
    status: 'pending' | 'thinking' | 'generating' | 'complete' | 'error';
    
    // Persisted Metrics
    startTime?: number;         // Timestamp when generation for this response started
    thinkingEndTime?: number;   // Timestamp when the 'thinking' phase ended
    endTime?: number;           // Timestamp when the response was fully received
    thinkingTokens?: number;    // Total tokens from the 'thinking' phase
    responseTokens?: number;    // Total tokens from the 'response' phase
}
```

### 2.2. New UI Rendering Logic

The main view's logic will no longer be a simple binary switch based on the *cycle's* status. It will be driven by the *active tab's* response status.

**Logic in `view.tsx`:**
```
const activeTab = tabs[activeTabId];
const showProgressView = activeTab?.status === 'generating' || activeTab?.status === 'thinking';

if (showProgressView) {
  // Render <GenerationProgressDisplay />
} else {
  // Render <ResponsePane />
}
```
This allows the UI to correctly show the progress view for a tab that is actively generating (including a re-generation) but show the parsed content for a tab that is complete.

## 3. Technical Implementation Plan

1.  **Update Data Model (`pcpp.types.ts`):**
    *   Update the `PcppResponse` interface as defined in section 2.1.

2.  **Update Backend (`llm.service.ts`):**
    *   Refactor the `generateBatch` stream handler.
    *   It will now create a richer `GenerationProgress` object that includes `startTime`.
    *   As it processes chunks, it will distinguish between `reasoning_content` and `content`, summing their token counts into `thinkingTokens` and `responseTokens` respectively.
    *   It will capture `thinkingEndTime` and `endTime` timestamps.
    *   When a stream for a response ends, it will pass this complete metrics object to the history service.

3.  **Update Backend (`history.service.ts`):**
    *   Refactor `updateCycleWithResponses` to accept this new, richer response object and save all the new metric fields to `dce_history.json`.
    *   **Fix Title Bug:** Modify `createNewCyclePlaceholder` to set the `title` to `"New Cycle"` instead of `"Cycle X - Generating..."`.

4.  **Refactor Frontend (`view.tsx` and hooks):**
    *   Implement the new per-tab rendering logic described in section 2.2.
    *   Update the `GenerationProgressDisplay.tsx` component to source its data from the `PcppResponse` objects of the current cycle. This ensures that when the view is reloaded for a "generating" cycle, it can reconstruct its state from the persisted metrics in `dce_history.json`.

5.  **Add Manual View Toggle (UX Fallback):**
    *   Add a new button to the `WorkflowToolbar`.
    *   This button will be visible only when viewing a cycle with a status of `'complete'`.
    *   It will toggle a local `useState` boolean that overrides the main logic, allowing the user to manually switch between the `ResponsePane` and the (now historical) `GenerationProgressDisplay` for that cycle.